/*
================================================================================
EXCEPTION MANAGEMENT PRIMARY KEY LOGIC - TRIAGE QUEUE ANALYSIS
================================================================================

PURPOSE:
This script creates a comprehensive view of Triage Queue (QT) instances by assigning
Store-Rx-Fill composite keys through multiple data source linkage methods. It enables
analysis of pharmacy exception management processes and workflow efficiency.

BUSINESS CONTEXT:
- Triage Queue contains pharmacy exceptions requiring manual intervention
- Exceptions may relate to prescription fills, outbound contacts, or action notes
- Multiple linking methods ensure maximum data coverage and completeness
- Supports operational analytics for exception resolution and process improvement

KEY FUNCTIONALITY:
1. Links triage queue items to prescription fills via multiple pathways
2. Creates composite keys for unique identification across systems
3. Adds triage classification and fiscal reporting dimensions
4. Enables comprehensive exception management analysis

LINKING METHODOLOGY HIERARCHY:
1. Direct QT key (if store/rx/fill available in triage queue)
2. Prescription Fill Interface (PFI) key via RXC_PRESCRIPTION_FILL_ID
3. Outbound Contact (OBD) key via prescription fill linkage
4. Action Note (AN) key via RXC_ACTION_NOTE_ID
5. COALESCE prioritizes available keys for maximum coverage

OUTPUT: Analytical dataset for exception management reporting and process optimization
================================================================================
*/

-- ASSIGN A STORE-RX-FILL KEY TO ALL QT INSTANCES BASED ON DIFFERENT METHODS
CREATE OR REPLACE TABLE DL_RX_OPERATION.RPHAI_DS_SANDBOX.QT_EXCEPTION_MANAGEMENT_SP
AS (
WITH TRIAGE_DATA AS (
    SELECT
        DISTINCT
            QT.*,                                                          -- All triage queue fields
            -- PRIMARY KEY GENERATION: Create composite keys from different data sources
            CONCAT(QT.STORE_NBR, '-', QT.RX_NBR, '-', QT.RX_FILL_NBR) AS QT_KEY,     -- Method 1: Direct from triage queue
            CONCAT(X1.STORE_NBR, '-', X1.RX_NBR, '-', X1.FILL_NBR) AS PFI_KEY,       -- Method 2: Via prescription fill interface
            CONCAT(X2.STORE_NBR, '-', X2.RX_NBR, '-', X2.FILL_NBR) AS OBD_KEY,       -- Method 3: Via outbound contact linkage
            CONCAT(AN.STORE_NBR, '-', AN.RX_NBR, '-', AN.FILL_NBR) AS AN_KEY,        -- Method 4: Via action note linkage
            
            -- HIERARCHICAL KEY SELECTION: Choose best available key using priority order
            COALESCE(QT_KEY, PFI_KEY, OBD_KEY, AN_KEY) AS FINAL_KEY,
            
            -- BUSINESS CLASSIFICATION: Add triage metadata for analysis
            DTL.TRIAGE_GROUP,                   -- High-level exception category
            DTL.TRIAGE_ITEM_TYPE_DETAIL_DSC,    -- Detailed exception description
            DTL.QT_TYPE,                        -- Queue type classification
            
            -- TEMPORAL DIMENSION: Add fiscal reporting period
            FQ.FISCAL_QUARTER_NBR               -- Fiscal quarter for executive reporting
    FROM
        CORE_RX.CURATED_SCRIPT.TRIAGE_QUEUE QT  -- Base triage queue data
    -- METHOD 1 LINKAGE: Direct prescription fill reference from triage queue
    LEFT JOIN
        CORE_RX.CURATED_SCRIPT.PRESCRIPTION_FILL_XREF X1
     ON QT.RXC_PRESECRIPTION_FILL_ID = X1.RXC_PRESCRIPTION_FILL_ID  -- Direct prescription fill link
     AND X1.REC_EFF_TS > DATEADD(MONTH, -12, $START_DATE)          -- Performance filter: 12-month lookback
    -- METHOD 2 LINKAGE: Via outbound contact system (for communication-related exceptions)
    LEFT JOIN
        CORE_RX.CURATED_OUTREACH.RXC_OUTBOUND_CONTACT OBD
     ON QT.OUTBOUND_CONTACT_ID = OBD.RXC_OUTBOUND_CONTACT_ID        -- Link triage to outbound contact
     AND OBD.REC_EFF_TS > DATEADD(MONTH, -12, $START_DATE)         -- Performance filter: 12-month lookback
    LEFT JOIN
        CORE_RX.CURATED_SCRIPT.PRESCRIPTION_FILL_XREF X2
     ON OBD.RXC_PRESCRIPTION_FILL_ID = X2.RXC_PRESCRIPTION_FILL_ID  -- Link outbound contact to prescription
     AND X2.REC_EFF_TS > DATEADD(MONTH, -12, $START_DATE)          -- Performance filter: 12-month lookback
    -- METHOD 3 LINKAGE: Via action notes (for clinical/procedural exceptions)
    LEFT JOIN
        CORE_RX.CURATED_SCRIPT.RXC_ACTION_NOTE AN
     ON AN.RXC_ACTION_NOTE_ID = QT.ACTION_NOTE_ID                   -- Link triage to action notes
     AND AN.REC_EFF_TS > DATEADD(MONTH, -12, $START_DATE)          -- Performance filter: 12-month lookback
    -- BUSINESS METADATA ENRICHMENT: Add triage classification details
    LEFT JOIN DL_RX_OPERATION.RX_OPS_SANDBOX.REF_QT_TRIAGE_ITEM_DESC_SP DTL
     ON  QT.TRIAGE_ITEM_TYPE_DETAIL_ID = DTL.TRIAGE_ITEM_TYPE_DETAIL_ID  -- Link to triage item descriptions
    
    -- FISCAL CALENDAR INTEGRATION: Add reporting period dimension
    INNER JOIN CORE_FSSC.CURATED_CALENDAR.FISCAL_QUARTER FQ
     ON QT.DISPOSITION_TS BETWEEN FQ.START_DT AND FQ.END_DT          -- Match disposition date to fiscal quarter
     AND FQ.FISCAL_QUARTER_NBR IN (20252)                           -- Filter to specific fiscal quarter (Q2 FY2025)
        )
-- FINAL OUTPUT: Complete triage dataset with all linkage methods and business dimensions
SELECT * FROM TRIAGE_DATA);

/*
================================================================================
INPUT TABLES AND THEIR FEATURES
================================================================================

1. CORE_RX.CURATED_SCRIPT.TRIAGE_QUEUE (Primary Source)
   - RXC_PRESCRIPTION_FILL_ID: Direct link to prescription fills
   - OUTBOUND_CONTACT_ID: Link to customer communication events
   - ACTION_NOTE_ID: Link to clinical/procedural notes
   - STORE_NBR: Store number (may be NULL, requiring linkage)
   - RX_NBR: Prescription number (may be NULL, requiring linkage)  
   - RX_FILL_NBR: Fill number (may be NULL, requiring linkage)
   - TRIAGE_ITEM_TYPE_DETAIL_ID: Exception type classification
   - DISPOSITION_TS: Exception resolution timestamp
   - All other triage queue fields (status, priority, assignment, etc.)

2. CORE_RX.CURATED_SCRIPT.PRESCRIPTION_FILL_XREF (Linkage Table)
   - RXC_PRESCRIPTION_FILL_ID: Prescription fill identifier (PK)
   - STORE_NBR: Store number
   - RX_NBR: Prescription number
   - FILL_NBR: Fill number
   - REC_EFF_TS: Record effective timestamp (for performance filtering)

3. CORE_RX.CURATED_OUTREACH.RXC_OUTBOUND_CONTACT (Communication Data)
   - RXC_OUTBOUND_CONTACT_ID: Outbound contact identifier (PK)
   - RXC_PRESCRIPTION_FILL_ID: Link to prescription fills
   - REC_EFF_TS: Record effective timestamp (for performance filtering)
   - Communication details (contact type, disposition, timestamps, etc.)

4. CORE_RX.CURATED_SCRIPT.RXC_ACTION_NOTE (Clinical Notes)
   - RXC_ACTION_NOTE_ID: Action note identifier (PK)
   - STORE_NBR: Store number
   - RX_NBR: Prescription number
   - FILL_NBR: Fill number
   - REC_EFF_TS: Record effective timestamp (for performance filtering)
   - Clinical note details (note text, category, pharmacist, etc.)

5. DL_RX_OPERATION.RX_OPS_SANDBOX.REF_QT_TRIAGE_ITEM_DESC_SP (Reference Data)
   - TRIAGE_ITEM_TYPE_DETAIL_ID: Triage item type identifier (PK)
   - TRIAGE_GROUP: High-level exception category
   - TRIAGE_ITEM_TYPE_DETAIL_DSC: Detailed exception description
   - QT_TYPE: Queue type classification
   - Business rules and workflow routing information

6. CORE_FSSC.CURATED_CALENDAR.FISCAL_QUARTER (Calendar Dimension)
   - START_DT: Fiscal quarter start date
   - END_DT: Fiscal quarter end date
   - FISCAL_QUARTER_NBR: Fiscal quarter number (20252 = Q2 FY2025)
   - Additional fiscal calendar attributes

================================================================================
OUTPUT TABLE AND FINAL FEATURES
================================================================================

TABLE: DL_RX_OPERATION.RPHAI_DS_SANDBOX.QT_EXCEPTION_MANAGEMENT_SP

RECORD GRAIN: One row per triage queue exception with enriched prescription keys
TYPICAL VOLUME: 10,000-50,000 records per fiscal quarter (varies by network size)
UPDATE FREQUENCY: Quarterly refresh aligned with fiscal reporting periods

Core Triage Fields (from QT.*):
- All original triage queue fields including status, priority, timestamps
- Exception handling workflow information
- Assignment and resolution tracking data

Generated Primary Keys:
- QT_KEY: Direct triage queue key (STORE_NBR-RX_NBR-RX_FILL_NBR)
- PFI_KEY: Prescription fill interface key via RXC_PRESCRIPTION_FILL_ID
- OBD_KEY: Outbound contact derived key via communication linkage
- AN_KEY: Action note derived key via clinical note linkage
- FINAL_KEY: Best available key using COALESCE hierarchy (Primary analytical key)

Business Classification Fields:
- TRIAGE_GROUP: High-level exception category (Clinical, Operational, Insurance, etc.)
- TRIAGE_ITEM_TYPE_DETAIL_DSC: Specific exception description (detailed business rules)
- QT_TYPE: Queue type classification (Priority, Standard, Clinical Review, etc.)

Temporal Dimension:
- FISCAL_QUARTER_NBR: Fiscal quarter for executive reporting (20252 = Q2 FY2025)

KEY BUSINESS APPLICATIONS:
================================================================================

OPERATIONAL ANALYTICS:
- Exception resolution time analysis by triage group and type
- Workload distribution and capacity planning
- Staff productivity and efficiency metrics
- Process bottleneck identification

QUALITY MANAGEMENT:
- Exception root cause analysis using prescription linkages
- Repeat exception pattern identification
- Clinical intervention effectiveness measurement
- Customer communication impact assessment

EXECUTIVE REPORTING:
- Quarterly exception volume and trend analysis
- Store-level exception management performance
- Network-wide process improvement ROI
- Regulatory compliance and audit support

DATA QUALITY CONSIDERATIONS:
- Multiple linkage methods maximize prescription key coverage (~95%+ expected)
- 12-month lookback balances performance with data completeness
- DISTINCT clause handles potential many-to-many relationships
- COALESCE hierarchy ensures consistent primary key assignment
- Fiscal quarter filtering focuses analysis on relevant business periods

================================================================================
*/
