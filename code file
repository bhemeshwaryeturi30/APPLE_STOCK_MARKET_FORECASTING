--Snowflake source
--Automation Script Volume

SELECT STR.STORE_NBR,    
str.division_nbr,
str.rx_region_nbr,
str.rx_area_nbr,
STR.RX_DISTRICT_NBR,
STR.STATE_CD,
STR.HR24_IND,
STR.AUTOMATION_DETAIL_CD,
FISCAL_WEEK_NBR,
Sum (CASE WHEN scripts.ACC_SCAN_STATUS_CD = '5' THEN 1 ELSE 0 end) AS AUTOFILLS,
COUNT(DISTINCT scripts.RXC_PRESCRIPTION_FILL_ID) as TotalFills,
sum( CASE WHEN MOD(scripts.dispense_qty,drug.package_size_amt) =0  then 1 else 0 end) AS CurrentUOU
FROM CORE_RX.CURATED_SCRIPT.PRESCRIPTION_FILL as scripts
JOIN core_fssc.curated_calendar.day as cal
    on to_date(scripts.rec_eff_ts) = cal.date_dt 
JOIN CORE_RX.CURATED_LOCATION.STORE AS STR
    ON SCRIPTS.STORE_NBR = STR.STORE_NBR
    and STR.AUTOMATION_DETAIL_CD IS NOT NULL AND (STR.AUTOMATION_REMOVAL_DT IS NULL OR STR.AUTOMATION_REMOVAL_DT < STR.AUTOMATION_INSTALL_DT)
    JOIN CORE_RX.CURATED_PRODUCT.DRUG as drug 
on scripts.ndc = drug.ndc
LEFT JOIN sem_rx.common_rx.sem_drug AS sem_drug
    ON sem_drug.NDC = scripts.NDC
--WHERE DRUG.NIOSH_DRUG_TABLE_IND is null and drug.dosage_form_nm in ('TA','CA')
--and DRUG.DEA_CD = 0 and drug.package_size_amt >=60
--and sem_drug.strength_unit_of_measure_cd is not null
--and  contains(lower(sem_drug.package_dsc),'bottle') and (NOT DOSAGE_FORM_CD IN ('CHEW','SUBL'))
where cal.FISCAL_month_NBR >= 202501
AND FILL_STATUS_CD IN ('6','7','9')
and Fill_state_cd = 1
GROUP BY all
