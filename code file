create or replace table IQVIA_Nathan_Clean as

select a.month_year_code,a.state,a.extended_pay_type_w_ffs_med,

case when a.pbm in ('AETNA PHARMACY MGT (PROC-UNSP)', 'MERIDIANRX (PROC-UNSP)', 'RXAMERICA (PROC-UNSP)') then 'CAREMARK'

when a.pbm in ('CURASCRIPT PHARMACY (PROC-UNSP)','MEDCO HLTH SOLUTIONS (PROC-UNSP)','WELLPOINT NEXTRX (PROC-UNSP)', 'EXPRESS SCRIPTS (PROC-UNSP)') then 'EXPRESS SCRIPTS'

when a.pbm in ('CATALYST RX (PROC-UNSP)','CATAMARAN (PROC-UNSP)','HEALTH TRANS LLC (PROC-UNSP)','INNOVIANT PRES BEN (PROC-UNSP)','NATL MEDICAL HLT CARD(PROC-UNSP)','OPTUM WORKERS COMP (PROC-UNSP)','RESTAT (PROC-UNSP)','WALGREENS HLTH INIT (PROC-UNSP)') then 'OPTUMRX'

when a.pbm in ('KROGER RX PLNS (PROC-UNSP)') then 'PRIME THERAPEUTICS'

else replace(a.pbm,' (PROC-UNSP)') end as super_pbm,


replace(a.pbm,' (PROC-UNSP)') as pbm,

a.product_name,a.brand_generic_ind,

replace(a.trx_units,',') CVS_units,

replace(a.trx_count,',') CVS_Script_count,

round(try_cast(replace(a.cvs_core,',')as double))cvs_core,

round(try_cast(replace(a.schnucks,',')as double))schnucks,

round(try_cast(replace(a.target,',') as Double))target,

replace(a.ptrx_units,',')All_Retail_units,replace(a.ptrx_count,',')All_Retail_count


,case when

try_cast(replace(a.all_cots_ptrx_units,',') as double) > 0

then (try_cast(replace(a.all_cots_ptrx_units,',') as double) - try_cast(replace(a.trx_units,',') as double))

else 0 end as all_other_cot_units,

replace(a.all_cots_ptrx_units,',') all_cots_ptrx_units,

replace(a.all_cots_ptrx_count,',')all_cots_ptrx_count,


case when

(try_cast(replace(a.CHAIN_INDEP_PTRX_UNITS, ',') as double) + try_cast(replace(a.chain_ptrx_units,',') as double) + try_cast(replace(a.indep_ptrx_units,',') as double)) > 0

then

(try_cast(replace(a.CHAIN_INDEP_PTRX_UNITS, ',') as double) + try_cast(replace(a.chain_ptrx_units,',') as double) + try_cast(replace(a.indep_ptrx_units,',') as double)) - (replace(a.cvs_core,','))

else 0 end as Chain_indep_Units



,try_cast(replace(a.chain_indep_ptrx_count,',') as double) + try_cast(replace(a.chain_ptrx_count,',') as double) + try_cast(replace(a.indep_ptrx_count,',') as double) as Chain_indep_count


,case when

(try_cast(replace(a.food_mass_ptrx_units,',') as double) + try_cast(replace(a.food_ptrx_units,',') as double) + try_cast(replace(a.mass_ptrx_units,',') as double)) > 0

then

(try_cast(replace(a.food_mass_ptrx_units,',') as double) + try_cast(replace(a.food_ptrx_units,',') as double) + try_cast(replace(a.mass_ptrx_units,',') as double))- replace(a.schnucks,',')-replace(a.target,',')

else 0 end

as Food_Mass_units



,try_cast(replace(a.food_mass_ptrx_count,',') as double) + try_cast(replace(a.food_ptrx_count,',') as double) + try_cast( replace(a.mass_ptrx_count,',') as double) as Food_Mass_count


,case when b.trx_units is null then '0' else replace(b.trx_units,',') end as PY_Units

,case when b.trx_units is null then '0' else replace(b.ptrx_units,',') end as PY_retail_Units

--,case when b.trx_units is null then '0' else (try_cast(replace(a.trx_units,',') as double) - try_cast(replace(b.trx_units,',') as double))/try_cast(replace(b.trx_units,',') as double) end as PM_Growth

from

iqvia_nathan_union as a

left join iqvia_nathan_union as b

on try_cast(a.month_year_code as double) - 100 = try_cast(b.month_year_code as double)

and a.brand_generic_ind = b.brand_generic_ind

and a.state = b.state

and a.extended_pay_type_w_ffs_med = b.extended_pay_type_w_ffs_med

and a.pbm = b.pbm

and a.product_name = b.product_name

where a.month_year_code >= '202205';


-- Clean Rounding Errors and Invalid Data from load ----------------------------------------------

UPDATE IQVIA_Nathan_Clean a SET All_Retail_units = (all_other_cot_units+try_cast(CVS_CORE as double) +try_cast(target as double) +try_cast(schnucks as double) + chain_indep_units + food_mass_units) where (try_cast(All_Retail_units as double) <>(all_other_cot_units+try_cast(CVS_CORE as double) +try_cast(target as double) +try_cast(schnucks as double) + chain_indep_units + food_mass_units));

Delete from IQVIA_Nathan_Clean where month_year_code = 'Month Year Code';

Delete from IQVIA_Nathan_Clean where month_year_code is null;

-- ----------------------------------------------



create or replace table IQVIA_Nathan_Payer_Clean as

select a.month_year_code, extended_pay_type_wffs_med_mngd_medicaid_discount_cards,

case when a.pbm in ('AETNA PHARMACY MGT (PROC-UNSP)', 'MERIDIANRX (PROC-UNSP)', 'RXAMERICA (PROC-UNSP)') then 'CAREMARK'

when a.pbm in ('CURASCRIPT PHARMACY (PROC-UNSP)','MEDCO HLTH SOLUTIONS (PROC-UNSP)','WELLPOINT NEXTRX (PROC-UNSP)', 'EXPRESS SCRIPTS (PROC-UNSP)') then 'EXPRESS SCRIPTS'

when a.pbm in ('CATALYST RX (PROC-UNSP)','CATAMARAN (PROC-UNSP)','HEALTH TRANS LLC (PROC-UNSP)','INNOVIANT PRES BEN (PROC-UNSP)','NATL MEDICAL HLT CARD(PROC-UNSP)','OPTUM WORKERS COMP (PROC-UNSP)','RESTAT (PROC-UNSP)','WALGREENS HLTH INIT (PROC-UNSP)') then 'OPTUMRX'

when a.pbm in ('KROGER RX PLNS (PROC-UNSP)') then 'PRIME THERAPEUTICS'

else replace(a.pbm,' (PROC-UNSP)')

end as super_pbm,


replace(a.pbm,' (PROC-UNSP)') as pbm,payer,

usc5, usc5_desc,a.brand_generic_ind,replace(a.trx_units_r,',') CVS_units, replace(a.trx_count_r,',') CVS_Script_count,replace(a.cvs_core,',')cvs_core,replace(a.schnucks,',')schnucks

,replace(a.target,',')target,replace(a.ptrx_units_r,',')All_Retail_units,replace(a.ptrx_count_r,',')All_Retail_count,

replace(a.all_cots_ptrx_units,',')all_cots_ptrx_units, replace(a.all_cots_ptrx_count,',')all_cots_ptrx_count,

try_cast(replace(a.CHAIN_INDEP_PTRX_UNITS, ',') as double) + try_cast(replace(a.chain_ptrx_units,',') as double) + try_cast(replace(a.indep_ptrx_units,',') as double) - try_cast(replace(a.cvs_core,',') as double) as Chain_indep_Units

,try_cast(replace(a.chain_indep_ptrx_count,',') as double) + try_cast(replace(a.chain_ptrx_count,',') as double) + try_cast(replace(a.indep_ptrx_count,',') as double) as Chain_indep_count

,try_cast(replace(a.food_mass_ptrx_units,',') as double) + try_cast(replace(a.food_ptrx_units,',') as double) + try_cast(replace(a.mass_ptrx_units,',') as double) - try_cast(replace(a.schnucks,',')as double) - try_cast(replace(a.target,',')as double) as Food_Mass_units

,try_cast(replace(a.food_mass_ptrx_count,',') as double) + try_cast(replace(a.food_ptrx_count,',') as double) + try_cast( replace(a.mass_ptrx_count,',') as double) as Food_Mass_count

from iqvia_nathan_round5 as a;


-- Clean Rounding Errors and Invalid Data from load ----------------------------------------------

UPDATE IQVIA_Nathan_Payer_Clean a SET All_Retail_units = Chain_indep_Units + Food_Mass_units + try_cast(CVS_units as double) where try_cast(All_Retail_units as double) - Chain_indep_Units - Food_Mass_units - try_cast(CVS_units as double) <> 0 ;

-- ----------------------------------------------
