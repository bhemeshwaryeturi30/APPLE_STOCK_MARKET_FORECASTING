WITH CF_PNP as (
select 
      b.rx_nbr 
    , b.store_nbr AS CF_STORE_NBR 
    , b.fill_nbr 
    , CAST(A.DESTINATION_RECIPIENT_TXT AS INTEGER) AS HOME_STORE_NBR
    , STORE.RX_AREA_NBR AS DIVISION_NBR
    , STORE.RX_REGION_NBR AS REGION_NBR
    , STORE.RX_DISTRICT_NBR AS DISTRICT_NBR
    , MAX(a.ORDER_ID) as Order_ID
    , MAX(A.COURIER_NM) AS COURIER_NM
    , MAX(C.TRACKING_NBR) AS TRACKING_NBR
    , max(case when c.order_status_cd = 10 then c.rec_eff_ts else null end) as Order_date 
    , max(case when c.order_status_cd = 2 then c.rec_eff_ts else null end) as Prep_Date
    , max(case when c.order_status_cd = 13 then c.rec_eff_ts else null end) as Handoff_Date
    , max(case when c.order_status_cd = 4 then c.rec_eff_ts else null end) as Delivered_Date
    , max(case when c.order_status_cd = 8 then c.rec_eff_ts else null end) as Cancelled_Date
    , max(case when c.order_status_cd = 14 then c.rec_eff_ts else null end) as Attempted_Delivery 
    , max(case when c.order_status_cd = 20 then c.rec_eff_ts else null end) as Handoff_Failure
from core_fssc.curated_orders.order_delivery as a 
join core_fssc.curated_orders.order_delivery_item as b
    on a.order_id = b.order_id
    and a.store_nbr = b.store_nbr
join (select 
            order_id 
          , store_nbr 
          , order_status_cd 
          , rec_eff_ts
          ,TRACKING_NBR
      --history table does not have current record in it
      from core_fssc.curated_orders.order_delivery_history -- tracks all the status a package goes through except the current status
      union 
      select 
            order_id 
          , store_nbr 
          , order_status_cd 
          , rec_eff_ts
          ,TRACKING_NBR
      from core_fssc.curated_orders.order_delivery) as c -- tracks current status of a tranx
    on a.order_id = c.order_id 
    and a.store_nbr = c.store_nbr
JOIN CORE_RX.CURATED_LOCATION.STORE AS STORE
    ON CAST(A.DESTINATION_RECIPIENT_TXT AS INTEGER)=STORE.STORE_NBR
WHERE c.order_status_cd IN (2,4,8,10,13,14,20) -- Only the required activities
AND A.DELIVERY_SLA_CD='CF-STS' -- CF delivery code
AND TO_DATE(A.rec_eff_ts) >= Date('01/01/2024') -- keep this at 1/1/2024 for all of 2025. Some scripts were received in 2024 that were delivered in 2025 - these get filtered out if we set this to 1/1/2025
group by 1,2,3,4,5,6,7
having CF_STORE_NBR in('11339','11506','11507')
)

select 
          cal.FISCAL_WEEK_NBR 
        , CF_PNP.CF_STORE_NBR
        -- , CF_PNP.TRACKING_NBR -- add this back in to look into individual orders
        , FM.END_DT as Fiscal_Month_end_date
        , FW.start_dt as fiscal_week_start_dt
        , fm.start_dt as fiscal_month_start_dt
        , cal.FISCAL_MONTH_NBR
        , cal.Fiscal_year_nbr
        , FW.end_dt as Fiscal_Week_end_date
        , CF_PNP.HOME_STORE_NBR
        -- , CF_PNP.RX_NBR -- add this back in to look into individual orders
        -- , CF_PNP.Fill_nbr -- add this back in to look into individual orders
        , count(CF_PNP.order_id) as count_orders -- de-aggregate to look into individual orders
from CF_PNP
join  CORE_FSSC.CURATED_CALENDAR.DAY AS CAL
    ON TO_DATE(CF_PNP.Handoff_Date) = CAL.DATE_DT
    join CORE_FSSC.CURATED_CALENDAR.FISCAL_WEEK as FW
    on cal.fiscal_week_nbr = FW.fiscal_week_nbr
    join CORE_FSSC.CURATED_CALENDAR.FISCAL_MONTH as FM
    on FW.fiscal_month_nbr = FM.Fiscal_month_nbr
and FM.fiscal_month_nbr >= 202501
and FW.end_dt < current_date
    group by 1,2,3,4,5,6,7,8,9

order by 1,2,3
