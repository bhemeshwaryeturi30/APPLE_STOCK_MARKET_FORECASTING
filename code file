
--Snowflake Source

with CF_ACT as (
select 
      b.rx_nbr 
    , b.store_nbr AS CF_STORE_NBR 
    , b.fill_nbr 
    , CAST(A.DESTINATION_RECIPIENT_TXT AS INTEGER) AS HOME_STORE_NBR
    , XREF.RXC_PRESCRIPTION_FILL_ID
    , MAX(C.TRACKING_NBR) AS TRACKING_NBR
    , max(case when c.order_status_cd = 2 then c.rec_eff_ts else null end) as Prep_Date
    , max(case when c.order_status_cd = 13 then c.rec_eff_ts else null end) as Handoff_Date
    , max(case when c.order_status_cd = 4 then c.rec_eff_ts else null end) as Delivered_Date
from core_fssc.curated_orders.order_delivery as a 
join core_fssc.curated_orders.order_delivery_item as b
    on a.order_id = b.order_id
    and a.store_nbr = b.store_nbr
join (select 
            order_id 
          , store_nbr 
          , order_status_cd 
          , rec_eff_ts
          ,TRACKING_NBR
      --history table does not have current record in it
      from core_fssc.curated_orders.order_delivery_history -- tracks all the status a package goes through except the current status
      union 
      select 
            order_id 
          , store_nbr 
          , order_status_cd 
          , rec_eff_ts
          ,TRACKING_NBR
      from core_fssc.curated_orders.order_delivery) as c -- tracks current status of a tranx
    on a.order_id = c.order_id 
    and a.store_nbr = c.store_nbr
Join CORE_RX.CURATED_SCRIPT.PRESCRIPTION_FILL_XREF AS XREF
on XREF.STORE_NBR =CAST(A.DESTINATION_RECIPIENT_TXT AS INTEGER)
and XREF.FILL_NBR =b.fill_nbr
and XREF.RX_NBR = b.rx_nbr
JOIN CORE_RX.CURATED_LOCATION.STORE AS STORE
ON CAST(A.DESTINATION_RECIPIENT_TXT AS INTEGER)=STORE.STORE_NBR
WHERE c.order_status_cd IN (2,4,13) -- Only the required activities
AND A.DELIVERY_SLA_CD='CF-STS' -- CF delivery code
AND YEAR(A.rec_eff_ts) >= 2025 
group by 1,2,3,4,5
),
temp1 as (
SELECT 
CENTRAL_FILL_FACILITY_ID AS CF_STORE_NBR
,STORE_NBR
,STATE_CD AS ST_CD
,PRESCRIPTION_FILL_ID
,TIMEZONE_DSC AS TM_ZONE
,CAL_DAY.FISCAL_YEAR_NBR
,CAL_DAY.FISCAL_MONTH_NBR
,CAL_DAY.FISCAL_MONTH_END_DT
,CAL_DAY.FISCAL_WEEK_NBR
,CAL_DAY.FISCAL_WEEK_END_DT
,cal_Day.fiscal_week_start_dt
,cal_day.fiscal_month_start_dt
,CAL_DAY.DAY_OF_WEEK_DSC AS DOW
,TIME_ADJ_HOLDING_QUEUE_OUT_TS AS HOLDING_QUEUE_OUT

FROM(
    SELECT 
    CF_RX_ASS.CENTRAL_FILL_FACILITY_ID
    ,STR.STORE_NBR
    ,STR.STATE_CD
    ,STR.TIMEZONE_DSC
    ,CF_RX_ASS.HOLDING_QUEUE_OUT_TS
    ,CASE
    WHEN STR.TIMEZONE_DSC = 'Central' THEN TIMESTAMPADD(HOUR,-1,CF_RX_ASS.HOLDING_QUEUE_OUT_TS) -- we are localizing the timezone from EST to regional clock
    WHEN STR.TIMEZONE_DSC IN ('Mountain AZ','Mountain') THEN TIMESTAMPADD(HOUR,-2,CF_RX_ASS.HOLDING_QUEUE_OUT_TS)
    WHEN STR.TIMEZONE_DSC = 'Pacific' THEN TIMESTAMPADD(HOUR,-3,CF_RX_ASS.HOLDING_QUEUE_OUT_TS)
    ELSE CF_RX_ASS.HOLDING_QUEUE_OUT_TS
    END AS TIME_ADJ_HOLDING_QUEUE_OUT_TS
    ,CF_RX_ASS.PRESCRIPTION_FILL_ID
    FROM CORE_RX.CURATED_SCRIPT.CENTRAL_FILL_RX_ASSIGNMENT AS CF_RX_ASS
    LEFT JOIN CORE_RX.CURATED_LOCATION.STORE AS STR
        ON STR.STORE_NBR = TO_NUMBER(CF_RX_ASS.HOME_STORE_FACILITY_ID)
    where CF_RX_ASS.holding_queue_out_ts is not null
    having hour(TIME_ADJ_HOLDING_QUEUE_OUT_TS) <=13
    ) AS ASSI
    INNER JOIN (
        SELECT t1.DATE_DT, t1.FISCAL_WEEK_NBR, t1.FISCAL_MONTH_NBR, t1.FISCAL_YEAR_NBR,
        t2.END_DT as FISCAL_WEEK_END_DT,
        t3.END_DT as FISCAL_MONTH_END_DT,
        t4.DAY_OF_WEEK_DSC,
        t2.start_dt as fiscal_week_start_dt,
        t3.start_dt as fiscal_month_start_dt,
        FROM CORE_FSSC.CURATED_CALENDAR.DAY t1
        INNER JOIN CORE_FSSC.CURATED_CALENDAR.FISCAL_WEEK t2 ON t1.FISCAL_WEEK_NBR = t2.FISCAL_WEEK_NBR
        INNER JOIN CORE_FSSC.CURATED_CALENDAR.FISCAL_MONTH t3 ON t1.FISCAL_MONTH_NBR = t3.FISCAL_MONTH_NBR
        INNER JOIN CORE_FSSC.CURATED_CALENDAR.DAY t4 ON t1.DAY_OF_WEEK_DSC = t4.DAY_OF_WEEK_DSC
    ) as CAL_DAY
    ON CAL_DAY.DATE_DT = TO_DATE(TIME_ADJ_HOLDING_QUEUE_OUT_TS)
   AND CAL_DAY.FISCAL_WEEK_NBR >= 202501
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14
)
select 
temp1.FISCAL_YEAR_NBR,
temp1.FISCAL_MONTH_NBR,
temp1.FISCAL_MONTH_END_DT,
temp1.FISCAL_WEEK_NBR,
temp1.FISCAL_WEEK_END_DT,
temp1.fiscal_week_start_dt,
temp1.fiscal_month_start_dt,
temp1.CF_STORE_NBR,
temp1.dow,
count (distinct case when (TO_DATE (CF_ACT.Handoff_Date) > TO_DATE(temp1.HOLDING_QUEUE_OUT))  then PRESCRIPTION_FILL_ID else null end) as fill_count
,count (distinct PRESCRIPTION_FILL_ID) as total_fill_count
from CF_ACT 
join temp1 
on temp1.PRESCRIPTION_FILL_ID = CF_ACT.RXC_PRESCRIPTION_FILL_ID
and  temp1.STORE_NBR = CF_ACT.HOME_STORE_NBR
AND TEMP1.dow IN ('MON','TUE','WED','THU','FRI')
and temp1.FISCAL_WEEK_END_DT < current_date()
and DAYOFWEEKISO(CF_ACT.Handoff_Date) IN (1,2,3,4,5,6)
Group by 1,2,3,4,5,6,7,8,9
order by 2,4,6,7
