DROP TABLE DL_RX_OPERATION.RX_OPS_SANDBOX.MD_BYPASS_RATES_ACT1;
CREATE TABLE DL_RX_OPERATION.RX_OPS_SANDBOX.MD_BYPASS_RATES_ACT1 AS
(
                SELECT
              ST.RX_AREA_NBR AS AREA_NBR
                ,ST.RX_REGION_NBR AS RGN_NBR
               ,ST.RX_DISTRICT_NBR  AS DSTRT_NBR
               ,ST.STORE_NBR
                ,ST.STATE_CD AS ST_CD
                ,CAL.FISCAL_week_NBR
                 ,ACT.ACTIVITY_CD --TO GET DEV_BYPASS & WAVE BYPASS
                 ,(CASE WHEN ACT.ACTIVITY_CD = '101' THEN '101' ELSE '0' END) DEV_BYPASS
                 ,(CASE WHEN ACT.ACTIVITY_CD = '40' THEN '40' ELSE '0' END) DEV
                ,(CASE WHEN ACT.ACTIVITY_CD = '111' THEN '111' ELSE '0' END) WAVE_BYPASS
                ,(CASE WHEN ACT.ACTIVITY_CD = '109' THEN '109' ELSE '0' END) WAVE
                ,(CASE WHEN ACT.ACTIVITY_CD = '101' AND ACT.ACTIVITY_CD = '111' THEN '1' ELSE '0' END) as QV1_BYPASS
                ,COUNT (DISTINCT pf.rxc_prescription_fill_id) AS SCRIPT_COUNTS
                FROM CORE_RX.CURATED_SCRIPT.PRESCRIPTION_FILL as PF
                 JOIN SEM_RX.COMMON_RX.SEM_STORE ST
                                ON PF.STORE_NBR = ST.STORE_NBR
                join CORE_RX.CURATED_SCRIPT.PRESCRIPTION_FILL_ACTIVITY as act
                on pf.rxc_prescription_fill_id = act.rxc_prescription_fill_id
              JOIN CORE_FSSC.Curated_CALENDAR.DAY CAL
                                ON act.CREATE_TS::DATE = CAL.DATE_DT
 
            WHERE act.CREATE_TS::DATE BETWEEN CURRENT_DATE - 93 AND CURRENT_DATE
                AND ACT.ACTIVITY_CD IN (40,101,109,111) --DEV AND WAVE indicators 
           --    AND ST.RX_AREA_NBR IN (0,2,4,8,12,14,16,22,25,30) 
	 AND PF.FILL_STATUS_CD IN (6,7,9) /* WAITING BIN, SOLD, RTSED */
                GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12
) --WITH DATA PRIMARY INDEX (STORE_NBR, FISCAL_WEEK_NBR)
;
 
select * from DL_RX_OPERATION.RX_OPS_SANDBOX.MD_BYPASS_RATES_ACT1;
