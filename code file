--below code is for the DEV Deprioritizaton Rates automated in Alation to run on Wednesdays at 10:30am uploaded in Tableau at 8am on Thursdays to account for Teradata slowness
  --below is used to populate the overall deprioritization rates for the chain
 
--DROP table MD_DEPRIORALL37;      
create or replace temporary TABLE MD_DEPRIORALL37
AS
(
select 
PF.RX_NBR AS RX_NBR, 
SFVQ.RXC_VERF_QUEUE_SQ_ID AS FILL_ID,     
PF.RXC_PRESCRIPTION_FILL_ID AS RXC_FILL_ID,       
PF.STORE_NBR,       
PF.PRESCRIPTION_FILL_TS,        
PF.FILL_NBR,
PF.FILL_STATUS_CD,      
PF.DATA_ENTRY_VERIFICATION_BYPASS_IND,
SFVQ.QV_STATUS_CD,       
SFVQ.QV_DISPOSITION_CD,      
(CASE WHEN SFVQ.SUPERVISOR_DOCTOR_DEPRIORITIZE_IND = 'Y' THEN 1 ELSE 0 END) SUPPHYSNDPRTZ,       
(CASE WHEN SFVQ.SIG_DEPRIORITIZE_IND = 'Y' THEN 1 ELSE 0 END) SIGDPRTZ,        
(CASE WHEN SFVQ.DRUG_DEPRIORITIZE_IND = 'Y' THEN 1 ELSE 0 END) DRUGDPRTZ,      
(CASE WHEN SFVQ.PRESCRIBER_DEPRIORITIZE_IND = 'Y' THEN 1 ELSE 0 END) PRESCRBRDPRTZ,        
(CASE WHEN SFVQ.PRESCRIPTION_DATE_DEPRIORITIZE_IND = 'Y' THEN 1 ELSE 0 END) PRSCRTDT,      
(CASE WHEN SFVQ.PATIENT_DEPRIORITIZE_FLAG = 'Y' THEN 1 ELSE 0 END) PNTDPRTZ,       
(CASE WHEN SFVQ.QUANTITY_DEPRIORITIZE_IND = 'Y' THEN 1 ELSE 0 END) QTYDPRTZ     
FROM CORE_RX.CURATED_SCRIPT.PRESCRIPTION_VERIFICATION_QUEUE as SFVQ     
JOIN CORE_RX.CURATED_SCRIPT.PRESCRIPTION_FILL as PF     
ON SFVQ.STORE_NBR = PF.STORE_NBR
AND SFVQ.RX_NBR = PF.RX_NBR
AND SFVQ.FILL_NBR = PF.FILL_NBR
-- where PF.PRESCRIPTION_FILL_TS::DATE >= (date - interval '56' day) 
-- and PF.PRESCRIPTION_FILL_TS::DATE <= (date - interval '3' day) 
WHERE PF.PRESCRIPTION_FILL_TS::DATE between CURRENT_DATE - 72 AND CURRENT_DATE  --6 WEEKS
--WHERE PF.PRESCRIPTION_FILL_TS::DATE between '2024-02-01' and '2024-02-29' --1 month to compare to IDW
AND PF.FILL_STATUS_CD IN (6,7,9)      
--AND PF.DATA_ENTRY_VERIFICATION_BYPASS_IND = 'N'  
AND SFVQ.QV_STATUS_CD = '122'        
AND SFVQ.QV_DISPOSITION_CD = '64'        
AND PF.RX_NBR is not null      
AND PF.RX_ORIGIN_CD = '3'
) ;      
SELECT * FROM md_depriorall37 where store_nbr = '00326';
 
--DROP TABLE MD_FINALDEPRIORALL37;
create or replace temporary TABLE MD_FINALDEPRIORALL37     
AS (        
SELECT 
DEPRIOR.FILL_ID  
,DEPRIOR.RXC_FILL_ID
,DEPRIOR.PRESCRIPTION_FILL_TS
,DEPRIOR.RX_NBR     
,DEPRIOR.STORE_NBR
,DEPRIOR.FILL_NBR       
,DEPRIOR.FILL_STATUS_CD
,DEPRIOR.DATA_ENTRY_VERIFICATION_BYPASS_IND
,DEPRIOR.QV_STATUS_CD
,DEPRIOR.QV_DISPOSITION_CD
,MAX(SUPPHYSNDPRTZ) AS SUPPHYSNDPRTZ
,MAX(SIGDPRTZ) AS SIGDPRTZ
,MAX(DRUGDPRTZ) AS DRUGDPRTZ        
,MAX(PRESCRBRDPRTZ) AS PRESCRBRDPRTZ        
,MAX(PRSCRTDT) AS PRSCRTDT      
,MAX(PNTDPRTZ) AS PNTDPRTZ      
,MAX(QTYDPRTZ) AS QTYDPRTZ      
FROM MD_DEPRIORALL37 AS DEPRIOR      
--WHERE CAST(DEPRIOR.SCRIPT_FILL_DT as DATE) >= (date - interval '56' day) 
--and CAST(DEPRIOR.SCRIPT_FILL_DT as DATE) <= (date - interval '3' day) 
WHERE DEPRIOR.PRESCRIPTION_FILL_TS::DATE between CURRENT_DATE - 72 AND CURRENT_DATE  --6 WEEKS
--WHERE DEPRIOR.PRESCRIPTION_FILL_TS::DATE between '2024-02-01' and '2024-02-29' --1 month to compare to IDW
GROUP BY 1,2,3,4,5,6,7,8,9,10 
);   

--DROP TABLE MD_LASTFORDEPRIORALL37;
create or replace temporary TABLE MD_LASTFORDEPRIORALL37   
AS (  
SELECT  DEPRIOR.FILL_ID    
,DEPRIOR.RXC_FILL_ID
,DEPRIOR.PRESCRIPTION_FILL_TS
,DEPRIOR.RX_NBR     
,DEPRIOR.STORE_NBR
,DEPRIOR.FILL_NBR       
,DEPRIOR.FILL_STATUS_CD      
,DEPRIOR.DATA_ENTRY_VERIFICATION_BYPASS_IND
,DEPRIOR.QV_STATUS_CD        
,DEPRIOR.QV_DISPOSITION_CD
,CASE WHEN RX_AREA_NBR IN (0,2,4,8,12,14,16,22,25,30) THEN 'Entire Chain' ELSE 'Non-Retail' end AS ENTIRE_CHAIN
,SUM(SUPPHYSNDPRTZ) AS SUPPHYSNDPRTZ
,SUM(SIGDPRTZ) AS SIGDPRTZ
,SUM(DRUGDPRTZ) AS DRUGDPRTZ        
,SUM(PRESCRBRDPRTZ) AS PRESCRBRDPRTZ        
,SUM(PRSCRTDT) AS PRSCRTDT      
,SUM(PNTDPRTZ) AS PNTDPRTZ      
,SUM(QTYDPRTZ) AS QTYDPRTZ      
,COUNT(DEPRIOR.FILL_ID) AS XCOUNTERX         
FROM MD_FINALDEPRIORALL37  AS DEPRIOR    
LEFT JOIN SEM_RX.COMMON_RX.SEM_STORE AS STR       
ON DEPRIOR.STORE_NBR = STR.STORE_NBR
--where CAST(DEPRIOR.SCRIPT_FILL_DT as DATE) >= (date - interval '56' day) 
--and CAST(DEPRIOR.SCRIPT_FILL_DT as DATE) <= (date - interval '3' day) 
WHERE DEPRIOR.PRESCRIPTION_FILL_TS::DATE between CURRENT_DATE - 72 AND CURRENT_DATE  --6 WEEKS
--WHERE DEPRIOR.PRESCRIPTION_FILL_TS::DATE between '2024-02-01' and '2024-02-29' --1 month to compare to IDW
 
GROUP BY 1,2,3,4,5,6,7,8,9,10,11
)  ; 
SELECT TOP 100* FROM MD_LASTFORDEPRIORALL37; 
  --below is used to get the final extract for the overall rates for stores needs to be a permanent table 
DROP TABLE  DL_RX_OPERATION.RX_OPS_SANDBOX.OVERALLDEPRIORRATE; --keep this as perm table
CREATE TABLE DL_RX_OPERATION.RX_OPS_SANDBOX.OVERALLDEPRIORRATE AS
(
SELECT      
  FISCAL_WEEK_NBR   
  ,be.STORE_NBR
  ,SUM(SUPPHYSNDPRTZ) AS SUPPHYSNDPRTZ
  ,SUM(SIGDPRTZ) AS SIGDPRTZ
  ,SUM(DRUGDPRTZ) AS DRUGDPRTZ        
  ,SUM(PRESCRBRDPRTZ) AS PRESCRBRDPRTZ        
  ,SUM(PRSCRTDT) AS PRSCRTDT      
  ,SUM(PNTDPRTZ) AS PNTDPRTZ      
  ,SUM(QTYDPRTZ) AS QTYDPRTZ      
  ,COUNT(BE.RXC_FILL_ID) AS XCOUNTERX         
FROM MD_LASTFORDEPRIORALL37 AS BE     
LEFT JOIN CORE_FSSC.CURATED_CALENDAR.DAY AS CAL      
ON BE.PRESCRIPTION_FILL_TS::DATE = CAL.DATE_DT        
LEFT JOIN SEM_RX.COMMON_RX.SEM_STORE AS STR       
ON BE.STORE_NBR   =  STR.STORE_NBR   
--where CAST(BE.SCRIPT_FILL_DT as DATE) >= (date - interval '56' day) 
--and CAST(BE.SCRIPT_FILL_DT as DATE) <= (date - interval '3' day) 
WHERE BE.PRESCRIPTION_FILL_TS::DATE BETWEEN CURRENT_DATE - 72 AND CURRENT_DATE  --6 WEEKS
--WHERE BE.PRESCRIPTION_FILL_TS::DATE  between '2024-02-01' and '2024-02-29' --1 month to compare to IDW
--AND be.STORE_NBR = '00326'
GROUP BY 1,2
) ;
 
  --below is the final extract for the overall rates
SELECT * FROM DL_RX_OPERATION.RX_OPS_SANDBOX.OVERALLDEPRIORRATE ;
 
--used below to get the Rate of ALL NOT DEprioritized for the chain
--DROP TABLE MD_DEPRIORNOT37;    
CREATE or replace temporary TABLE MD_DEPRIORNOT37 
AS      
(       
SELECT      
PF.RX_NBR AS RX_NBR,        
SFVQ.RXC_VERF_QUEUE_SQ_ID AS FILL_ID,     
PF.RXC_PRESCRIPTION_FILL_ID AS RXC_FILL_ID,       
PF.STORE_NBR,     
PF.PRESCRIPTION_FILL_TS,        
PF.FILL_NBR,        
PF.FILL_STATUS_CD,       
PF.DATA_ENTRY_VERIFICATION_BYPASS_IND,
SFVQ.QV_STATUS_CD,       
SFVQ.QV_DISPOSITION_CD,      
(CASE WHEN SFVQ.SUPERVISOR_DOCTOR_DEPRIORITIZE_IND = 'N'  
AND SFVQ.SIG_DEPRIORITIZE_IND = 'N'      
AND SFVQ.DRUG_DEPRIORITIZE_IND = 'N' 
AND SFVQ.PRESCRIBER_DEPRIORITIZE_IND = 'N' 
AND SFVQ.PRESCRIPTION_DATE_DEPRIORITIZE_IND = 'N' 
AND SFVQ.PATIENT_DEPRIORITIZE_FLAG = 'N'       
AND SFVQ.QUANTITY_DEPRIORITIZE_IND = 'N' THEN 1 ELSE 0 END) ALL_NOT_DEPRIORITIZED     
FROM CORE_RX.CURATED_SCRIPT.PRESCRIPTION_VERIFICATION_QUEUE AS SFVQ 
JOIN CORE_RX.CURATED_SCRIPT.PRESCRIPTION_FILL AS PF     
ON SFVQ.STORE_NBR = PF.STORE_NBR
AND SFVQ.RX_NBR = PF.RX_NBR
AND SFVQ.FILL_NBR = PF.FILL_NBR
WHERE PF.PRESCRIPTION_FILL_TS::DATE BETWEEN CURRENT_DATE - 72 AND CURRENT_DATE  --6 WEEKS
--CAST(pf.prscrt_fill_dt as DATE) >= (date - interval '56' day) 
--and CAST(pf.prscrt_fill_dt as DATE) <= (date - interval '3' day) 
--WHERE PF.PRESCRIPTION_FILL_TS::DATE  between '2023-10-01' and '2023-10-31' --1 month to compare to IDW
 
AND FILL_STATUS_CD IN (6,7,9)      
--AND PF.DATA_ENTRY_VERIFICATION_BYPASS_IND = 'N'        
AND SFVQ.QV_STATUS_CD = '122'        
AND SFVQ.QV_DISPOSITION_CD = '64'        
AND PF.RX_NBR IS NOT NULL       
AND PF.RX_ORIGIN_CD = '3'
) ; 

--DROP TABLE MD_FINALDEPRIORNOT37;     
CREATE or replace temporary TABLE MD_FINALDEPRIORNOT37
AS (        
SELECT  DEPRIOR.FILL_ID     
,DEPRIOR.PRESCRIPTION_FILL_TS
,DEPRIOR.RX_NBR     
,DEPRIOR.STORE_NBR
,DEPRIOR.FILL_NBR       
,DEPRIOR.FILL_STATUS_CD      
,DEPRIOR.DATA_ENTRY_VERIFICATION_BYPASS_IND
,DEPRIOR.QV_STATUS_CD
,DEPRIOR.QV_DISPOSITION_CD
,MAX (ALL_NOT_DEPRIORITIZED) AS ALL_NOT_DEPRIORITIZED     
FROM MD_DEPRIORNOT37 AS DEPRIOR     
--where CAST(deprior.SCRIPT_FILL_DT as DATE) >= (date - interval '56' day) 
--and CAST(deprior.SCRIPT_FILL_DT as DATE) <= (date - interval '3' day) 
WHERE DEPRIOR.PRESCRIPTION_FILL_TS::DATE BETWEEN CURRENT_DATE - 72 AND CURRENT_DATE  --6 WEEKS
--WHERE DEPRIOR.PRESCRIPTION_FILL_TS::DATE BETWEEN '2023-10-01' and '2023-10-31' --1 month to compare to IDW
 
GROUP BY 1,2,3,4,5,6,7,8,9      
)  ;   
 
--DROP TABLE MD_LASTNOT37;
CREATE or replace temporary TABLE MD_LASTNOT37      
AS (  
SELECT  DEPRIOR.FILL_ID     
,DEPRIOR.PRESCRIPTION_FILL_TS
,DEPRIOR.RX_NBR     
,DEPRIOR.STORE_NBR        
,DEPRIOR.FILL_NBR       
,DEPRIOR.FILL_STATUS_CD      
,DEPRIOR.DATA_ENTRY_VERIFICATION_BYPASS_IND
,DEPRIOR.QV_STATUS_CD
,DEPRIOR.QV_DISPOSITION_CD
,SUM (ALL_NOT_DEPRIORITIZED) AS ALL_NOT_DEPRIORITIZED          
,COUNT(DEPRIOR.FILL_ID) AS NCOUNTERN         
FROM MD_FINALDEPRIORNOT37 AS DEPRIOR    
--where CAST(deprior.SCRIPT_FILL_DT as DATE) >= (date - interval '56' day) 
--and CAST(deprior.SCRIPT_FILL_DT as DATE) <= (date - interval '3' day) 
WHERE DEPRIOR.PRESCRIPTION_FILL_TS::DATE BETWEEN CURRENT_DATE - 72 AND CURRENT_DATE  --6 WEEKS
--WHERE DEPRIOR.PRESCRIPTION_FILL_TS::DATE BETWEEN '2023-10-01' and '2023-10-31' --1 month to compare to IDW
 
GROUP BY 1,2,3,4,5,6,7,8,9
) ;     
 
  --below is used to get the EXTRACT for the rates
 
DROP TABLE DL_RX_OPERATION.RX_OPS_SANDBOX.MD_FINALRESULTSN37; --keep this as perm table
CREATE TABLE DL_RX_OPERATION.RX_OPS_SANDBOX.MD_FINALRESULTSN37 AS
(
SELECT      
FISCAL_WEEK_NBR AS FISCAL  
,SUM(ALL_NOT_DEPRIORITIZED) AS ALL_NOT_DEPRIORITIZED             
,COUNT(BE.FILL_ID) AS NCOUNTERN         
FROM MD_LASTNOT37 AS BE     
LEFT JOIN CORE_FSSC.CURATED_CALENDAR.DAY AS CAL      
ON BE.PRESCRIPTION_FILL_TS::DATE = CAL.DATE_DT        
LEFT JOIN SEM_RX.COMMON_RX.SEM_STORE AS STR       
ON BE.STORE_NBR   =  STR.STORE_NBR   
--where CAST(BE.SCRIPT_FILL_DT as DATE) >= (date - interval '56' day) 
--and CAST(BE.SCRIPT_FILL_DT as DATE) <= (date - interval '3' day) 
WHERE BE.PRESCRIPTION_FILL_TS::DATE BETWEEN CURRENT_DATE - 72 AND CURRENT_DATE  --6 WEEKS
--WHERE BE.PRESCRIPTION_FILL_TS::DATE BETWEEN '2023-10-01' and '2023-10-31' --1 month to compare to IDW
 
GROUP BY 1 
);
 
  --below is used to get the EXTRACT for the rates for all N (N = not deprioritized)
SELECT * FROM DL_RX_OPERATION.RX_OPS_SANDBOX.MD_FINALRESULTSN37;
 
--used below for ALL Deprioritized
--DROP TABLE MD_DEPRIORYES37;      
CREATE or replace temporary TABLE MD_DEPRIORYES37
AS      
(       
SELECT      
PF.RX_NBR AS RX_NBR,        
SFVQ.RXC_VERF_QUEUE_SQ_ID AS FILL_ID,     
PF.RXC_PRESCRIPTION_FILL_ID AS RXC_FILL_ID,       
PF.STORE_NBR,     
PF.PRESCRIPTION_FILL_TS,        
PF.FILL_NBR,        
PF.FILL_STATUS_CD,       
PF.DATA_ENTRY_VERIFICATION_BYPASS_IND,
SFVQ.QV_STATUS_CD,       
SFVQ.QV_DISPOSITION_CD,      
(CASE WHEN SFVQ.SUPERVISOR_DOCTOR_DEPRIORITIZE_IND = 'Y'  
AND SFVQ.SIG_DEPRIORITIZE_IND = 'Y'      
AND SFVQ.DRUG_DEPRIORITIZE_IND = 'Y' 
AND SFVQ.PRESCRIBER_DEPRIORITIZE_IND = 'Y' 
AND SFVQ.PRESCRIPTION_DATE_DEPRIORITIZE_IND = 'Y' 
AND SFVQ.PATIENT_DEPRIORITIZE_FLAG = 'Y'       
AND SFVQ.QUANTITY_DEPRIORITIZE_IND = 'Y' THEN 1 ELSE 0 END) ALL_DEPRIORITIZED     
FROM CORE_RX.CURATED_SCRIPT.PRESCRIPTION_VERIFICATION_QUEUE AS SFVQ 
JOIN CORE_RX.CURATED_SCRIPT.PRESCRIPTION_FILL AS PF     
ON SFVQ.STORE_NBR = PF.STORE_NBR
AND SFVQ.RX_NBR = PF.RX_NBR
AND SFVQ.FILL_NBR = PF.FILL_NBR
--where CAST(pf.prscrt_fill_dt as DATE) >= (date - interval '56' day) 
--and CAST(pf.prscrt_fill_dt as DATE) <= (date - interval '3' day) 
WHERE PF.PRESCRIPTION_FILL_TS::DATE BETWEEN CURRENT_DATE - 72 AND CURRENT_DATE  --6 WEEKS
--WHERE PF.PRESCRIPTION_FILL_TS::DATE BETWEEN '2023-10-01' and '2023-10-31' --1 month to compare to IDW
 
AND FILL_STATUS_CD IN (6,7,9)      
--AND PF.DATA_ENTRY_VERIFICATION_BYPASS_IND = 'N'        
AND SFVQ.QV_STATUS_CD = '122'        
AND SFVQ.QV_DISPOSITION_CD = '64'        
AND PF.RX_NBR IS NOT NULL       
AND PF.RX_ORIGIN_CD = '3'
) ;

--DROP TABLE  MD_FINALDEPRIORYES37;     
CREATE or replace temporary TABLE MD_FINALDEPRIORYES37
AS (        
SELECT  DEPRIOR.FILL_ID     
,DEPRIOR.PRESCRIPTION_FILL_TS
,DEPRIOR.RX_NBR     
,DEPRIOR.STORE_NBR        
,DEPRIOR.FILL_NBR       
,DEPRIOR.FILL_STATUS_CD      
,DEPRIOR.DATA_ENTRY_VERIFICATION_BYPASS_IND 
,DEPRIOR.QV_STATUS_CD 
,DEPRIOR.QV_DISPOSITION_CD 
,MAX (ALL_DEPRIORITIZED) AS ALL_DEPRIORITIZED     
FROM MD_DEPRIORYES37 AS DEPRIOR   
--where CAST(deprior.SCRIPT_FILL_DT as DATE) >= (date - interval '56' day) 
--and CAST(deprior.SCRIPT_FILL_DT as DATE) <= (date - interval '3' day) 
WHERE DEPRIOR.PRESCRIPTION_FILL_TS::DATE BETWEEN CURRENT_DATE - 72 AND CURRENT_DATE --6 WEEKS
--WHERE DEPRIOR.PRESCRIPTION_FILL_TS::DATE BETWEEN '2023-10-01' and '2023-10-31' --1 month to compare to IDW
 
GROUP BY 1,2,3,4,5,6,7,8,9    
)  ;   

--DROP TABLE MD_LASTONE37;
CREATE or replace temporary TABLE MD_LASTONE37
AS (  
SELECT  DEPRIOR.FILL_ID     
,DEPRIOR.PRESCRIPTION_FILL_TS
,DEPRIOR.RX_NBR     
,DEPRIOR.STORE_NBR
,DEPRIOR.FILL_NBR       
,DEPRIOR.FILL_STATUS_CD      
,DEPRIOR.DATA_ENTRY_VERIFICATION_BYPASS_IND 
,DEPRIOR.QV_STATUS_CD 
,DEPRIOR.QV_DISPOSITION_CD 
,SUM (ALL_DEPRIORITIZED) AS ALL_DEPRIORITIZED          
,COUNT(DEPRIOR.FILL_ID) AS YCOUNTERY         
FROM MD_FINALDEPRIORYES37 AS DEPRIOR    
--where CAST(deprior.SCRIPT_FILL_DT as DATE) >= (date - interval '56' day) 
--and CAST(deprior.SCRIPT_FILL_DT as DATE) <= (date - interval '3' day) 
WHERE DEPRIOR.PRESCRIPTION_FILL_TS::DATE BETWEEN CURRENT_DATE - 72 AND CURRENT_DATE  --6 WEEKS
--WHERE DEPRIOR.PRESCRIPTION_FILL_TS::DATE BETWEEN '2023-10-01' and '2023-10-31' --1 month to compare to IDW
 
GROUP BY 1,2,3,4,5,6,7,8,9    
)  ;    
 
  --below is used to get the EXTRACT for the rates, see if this needs to be a permenant table. 
DROP TABLE  DL_RX_OPERATION.RX_OPS_SANDBOX.MD_FINALRESULTSY37 ; --keep this as perm table
 
CREATE TABLE DL_RX_OPERATION.RX_OPS_SANDBOX.MD_FINALRESULTSY37 AS
(
SELECT      
FISCAL_WEEK_NBR  AS FW   
,SUM(ALL_DEPRIORITIZED) AS ALL_DEPRIORITIZED             
,COUNT(BE.FILL_ID) AS YCOUNTERY         
FROM MD_LASTONE37 AS BE     
LEFT JOIN CORE_FSSC.CURATED_CALENDAR.DAY AS CAL      
ON BE.PRESCRIPTION_FILL_TS::DATE = CAL.DATE_DT        
LEFT JOIN SEM_RX.COMMON_RX.SEM_STORE AS STR       
ON BE.STORE_NBR   =  STR.STORE_NBR   
--where CAST(BE.SCRIPT_FILL_DT as DATE) >= (date - interval '56' day) 
--and CAST(BE.SCRIPT_FILL_DT as DATE) <= (date - interval '3' day) 
WHERE BE.PRESCRIPTION_FILL_TS::DATE BETWEEN CURRENT_DATE - 72 AND CURRENT_DATE  --6 WEEKS
--WHERE BE.PRESCRIPTION_FILL_TS::DATE BETWEEN '2023-10-01' and '2023-10-31' --1 month to compare to IDW
 
GROUP BY 1
);
 
  --below is used to get the EXTRACT for the rates for all Y (Y = deprioritized)
 
SELECT * FROM DL_RX_OPERATION.RX_OPS_SANDBOX.MD_FINALRESULTSY37;
 
DROP TABLE DL_RX_OPERATION.RX_OPS_SANDBOX.MD_DEPRIOR_RATE; --keep as permenant table
CREATE TABLE DL_RX_OPERATION.RX_OPS_SANDBOX.MD_DEPRIOR_RATE AS
(
SELECT 
OA.*
,ND.FISCAL, ND.ALL_NOT_DEPRIORITIZED
,YD.FW,YD.ALL_DEPRIORITIZED
FROM DL_RX_OPERATION.RX_OPS_SANDBOX.OVERALLDEPRIORRATE AS OA
RIGHT JOIN DL_RX_OPERATION.RX_OPS_SANDBOX.MD_FINALRESULTSN37 AS ND
ON OA.FISCAL_WEEK_NBR = ND.FISCAL
RIGHT JOIN DL_RX_OPERATION.RX_OPS_SANDBOX.MD_FINALRESULTSY37 AS YD
ON ND.FISCAL = YD.FW
);
 
SELECT fiscal_week_nbr, sigdprtz, pntdprtz, qtydprtz, drugdprtz, prscrtdt, xcounterx
FROM DL_RX_OPERATION.RX_OPS_SANDBOX.MD_DEPRIOR_RATE;
