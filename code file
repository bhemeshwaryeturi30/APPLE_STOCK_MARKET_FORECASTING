CREATE OR REPLACE TASK DL_RX_OPERATION.RX_OPS_SANDBOX.REFRESH_OFP
WAREHOUSE = WH_RX_QUERY_RXANALYTICS_01
SCHEDULE = 'USING CRON 0 5 * * 1-5 America/New_York'
AS CALL DL_RX_OPERATION.RX_OPS_SANDBOX.LOAD_OFP_DATA_PROC();

-- CALL DL_RX_OPERATION.RX_OPS_SANDBOX.LOAD_MONDAY_EMAIL_DATA_PROC()

-- DL_RX_OPERATION.RX_OPS_SANDBOX.OF_DRD
-- DL_RX_OPERATION.RX_OPS_SANDBOX.OFP
-- DL_RX_OPERATION.RX_OPS_SANDBOX.OF_ROLLUPS_TIMEFRAMES_DRD
-- DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_OFH_CAT_CANCEL_unit_update
-- DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_SFS_Resourced
-- DL_RX_OPERATION.RX_OPS_SANDBOX.OUTPUT_PREP
-- DL_RX_OPERATION.RX_OPS_SANDBOX.OF_Orders

-- DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_SDD_Order_flags
-- DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_BOPIS_Order_flags
-- DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_SDD_orders_action_times
-- DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_BOPIS_orders_action_times
-- DL_RX_OPERATION.RX_OPS_SANDBOX.BOPIS_SDD_ORDERS
-- DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_SDD_Full_Or_Partial
-- DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_SDD_order_cancel_reasons 
-- DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_SDD_Order_DRD

-- alter task DL_RX_OPERATION.RX_OPS_SANDBOX.REFRESH_MONDAY_EMAIL resume;
-- alter task DL_RX_OPERATION.RX_OPS_SANDBOX.REFRESH_OFP resume;
-- SELECT * FROM SNOWFLAKE.ACCOUNT_USAGE.TASK_HISTORY WHERE NAME = 'REFRESH_RX_PNP';


-- select * from CORE_FS.CURATED_OMS.OMNI_ECOM_FULFILLMENT_DTL limit 10;

-- Select date(order_date)
-- , count(distinct order_no)
-- from  "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_HEADER" poh
-- inner join "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_LINE" pol
-- on poh.order_header_key = pol.order_header_key
-- where poh.entry_type in ('ATGCSC','CVS.COM')
-- and pol.delivery_code = 'SDD'
-- and order_date >= current_date - 16
-- group by all;

-- Select actioned_date, sum(Orders) 
-- from DL_RX_OPERATION.RX_OPS_SANDBOX.OF_Orders 
-- where actioned_date >= current_date-7
-- group by all
-- order by 1;

-- select order_date, count(distinct order_no) 
-- from CORE_FS.CURATED_OMS.OMNI_ECOM_FULFILLMENT_DTL
-- where order_date >= current_date - 7
-- group by all
-- order by 1 desc;

CREATE OR REPLACE PROCEDURE DL_RX_OPERATION.RX_OPS_SANDBOX.LOAD_OFP_DATA_PROC()
RETURNS STRING
LANGUAGE SQL
EXECUTE AS CALLER
AS
$$
BEGIN

Create or replace temporary table Store_Ops_SDD_orders as
(Select order_no
, sum(original_ordered_qty) original_ordered_qty
, sum(SHIPPED_QUANTITY) SHIPPED_QUANTITY
from  "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_HEADER" poh
inner join "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_LINE" pol
on poh.order_header_key = pol.order_header_key
where poh.entry_type in ('ATGCSC','CVS.COM')
and pol.delivery_code = 'SDD'
and Year(to_date(order_date)) > Year(current_date) - 2
and to_date(order_date) >= '2023-09-14' --agreed start start to remove testing from data
group by 1);

Create or replace temporary table Store_Ops_SDD_lines as 
(Select order_line_key
from  "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_HEADER" poh
inner join "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_LINE" pol
on poh.order_header_key = pol.order_header_key
where poh.entry_type in  ('ATGCSC','CVS.COM')
and pol.delivery_code = 'SDD'
and Year(to_date(order_date)) > Year(current_date) - 2
and to_date(order_date) >= '2023-09-14' --agreed start start to remove testing from data
group by 1);

Create or replace table DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_SDD_Order_DRD as
(Select
a.order_no
, a.store_nbr
, Division
, Region
, District
From
--Order stores
(Select a.Order_no
, b.shipnode_key as store_nbr
from "CORE_FSSC"."CURATED_OMS"."YFS_SHIPMENT_LINE" a
left join "CORE_FSSC"."CURATED_OMS"."YFS_SHIPMENT" b
on a.SHIPMENT_KEY = b.SHIPMENT_KEY
where order_line_key in (Select * from Store_Ops_SDD_lines)
group by 1,2) a
left join
--DRD
(Select 
store_nbr
, FS_AREA_NBR as Division
, FS_REGION_NBR as Region
, FS_DISTRICT_NBR as District
from "CORE_RX"."CURATED_LOCATION"."STORE") b
on a.store_nbr = b.store_nbr
);

Create or replace table DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_SDD_order_cancel_reasons as (
Select 
poh.order_no
,pol.order_line_key
,case 
when coalesce(pol.EXTN_CANCEL_DESC,s.extn_shipment_cancelled_reason) in ('Out of Stock','Damaged','Danaged','Item Expired','Store Cancelation','SKU is OOS','PNP Record Shortage', 'Partially Filled') then 'Colleague_Cancelled'	
when coalesce(pol.EXTN_CANCEL_DESC,s.extn_shipment_cancelled_reason) in ('Order Missing', 'Order is missing') then 'Handoff_Miss'
else 'Other' end as Cancellation_Type
,coalesce(pol.EXTN_CANCEL_DESC,s.extn_shipment_cancelled_reason) as Cancelation_reason
,sum(original_ordered_qty) original_ordered_qty
,sum(SHIPPED_QUANTITY) SHIPPED_QUANTITY
from "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_HEADER" poh
left join "CORE_FSSC"."CURATED_OMS"."YFS_SHIPMENT" s
on poh.order_header_key = s.order_header_key
and s.extn_shipment_cancelled_reason is not null
inner join "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_LINE" pol
on poh.order_header_key = pol.order_header_key
where pol.order_line_key in (Select * from Store_Ops_SDD_lines)
and pol.delivery_code = 'SDD'
and coalesce(pol.EXTN_CANCEL_DESC,s.extn_shipment_cancelled_reason) is not null
group by 1,2,3,4);

Create or replace temporary table Store_Ops_SDD_Category_cancelations as 
(Select
poh.order_no
, pol.order_line_key
, item_id
, cat_dsc
--, ordered_qty
, original_ordered_qty --Demand
, original_ordered_qty - SHIPPED_QUANTITY as Canceled_QTY
, coalesce(pol.EXTN_CANCEL_DESC,s.extn_shipment_cancelled_reason) as cancellation_reason
from "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_HEADER" poh
left join "CORE_FSSC"."CURATED_OMS"."YFS_SHIPMENT" s
on poh.order_header_key = s.order_header_key
and s.extn_shipment_cancelled_reason is not null
inner join "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_LINE" pol
on poh.order_header_key = pol.order_header_key
left join "PROD_COMM_DB"."CDP_APP"."SKU_MF" SKU
ON pol.ITEM_ID = SKU.SKU_NBR
where pol.order_line_key in (Select * from Store_Ops_SDD_lines)
and pol.delivery_code = 'SDD'
and coalesce(pol.EXTN_CANCEL_DESC,s.extn_shipment_cancelled_reason)
in ('Out of Stock','Damaged','Danaged','Item Expired','Store Cancelation','SKU is OOS','PNP Record Shortage','Partially Filled')
and cat_dsc is not null);

Create or replace table DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_SDD_Full_Or_Partial as
(Select
a.Order_no
,Qty
,Canceled_QTY
, Case when Qty = Canceled_QTY then 'Full Cancelation'
	   when Qty <> Canceled_QTY then 'Partial Cancelation'
	   end as "Full or Partial"
from
(--Number of lines in an order
Select Order_no
, sum(original_ordered_qty) as Qty
from  "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_HEADER" poh
inner join "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_LINE" pol 
on poh.order_header_key = pol.order_header_key
where poh.entry_type in  ('ATGCSC','CVS.COM')
and pol.delivery_code = 'SDD'
and Year(to_date(order_date)) >= Year(current_date) - 3
and to_date(order_date) >= '2023-09-14' --agreed start start to remove testing from data
group by 1) a
Full outer Join
(--Number of lines that are canceled
Select 
poh.order_no
, sum(original_ordered_qty) - sum(SHIPPED_QUANTITY) Canceled_QTY
from "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_HEADER" poh
left join "CORE_FSSC"."CURATED_OMS"."YFS_SHIPMENT" s
on poh.order_header_key = s.order_header_key
and s.extn_shipment_cancelled_reason is not null
inner join "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_LINE" pol
on poh.order_header_key = pol.order_header_key
where pol.order_line_key in (Select * from Store_Ops_SDD_lines)
and pol.delivery_code = 'SDD'
and coalesce(pol.EXTN_CANCEL_DESC,s.extn_shipment_cancelled_reason) in ('Out of Stock','Damaged','Danaged','Item Expired','Store Cancelation','SKU is OOS','PNP Record Shortage','Partially Filled')
group by 1)b
on a.order_no = b.order_no
where Canceled_QTY is not null
);

CREATE OR REPLACE TEMPORARY TABLE SDD_Order_Timestamps AS (
SELECT 
A.OMS_ORDER_NBR
, delivery_sla_cd
, MAX(CASE WHEN C.ORDER_STATUS_CD = 10 THEN C.REC_EFF_TS ELSE NULL END) AS ORDER_DATE 
, MAX(CASE WHEN C.ORDER_STATUS_CD = 2 THEN C.REC_EFF_TS ELSE NULL END) AS PREP_DATE
, MAX(CASE WHEN C.ORDER_STATUS_CD in (26,13) THEN C.REC_EFF_TS ELSE NULL END) AS HANDOFF_DATE
, MAX(CASE WHEN C.ORDER_STATUS_CD = 4 THEN C.REC_EFF_TS ELSE NULL END) AS DELIVERED_DATE
, MAX(CASE WHEN C.ORDER_STATUS_CD = 8 THEN C.REC_EFF_TS ELSE NULL END) AS CANCELLED_DATE
, MAX(CASE WHEN C.ORDER_STATUS_CD = 14 THEN C.REC_EFF_TS ELSE NULL END) AS ATTEMPTED_DELIVERY 
, MAX(CASE WHEN C.ORDER_STATUS_CD = 20 THEN C.REC_EFF_TS ELSE NULL END) AS HANDOFF_FAILURE
, MAX(CASE WHEN C.ORDER_STATUS_CD = 5  THEN C.REC_EFF_TS ELSE NULL END) AS Courier_Return_Date_PNP
FROM CORE_FSSC.CURATED_ORDERS.ORDER_DELIVERY AS A 
JOIN CORE_FSSC.CURATED_ORDERS.ORDER_DELIVERY_ITEM AS B
ON A.ORDER_ID = B.ORDER_ID
AND A.STORE_NBR = B.STORE_NBR
--Used to remove mismatched timestamps?
JOIN (
  SELECT 
  ORDER_ID 
, STORE_NBR 
, ORDER_STATUS_CD 
, REC_EFF_TS 
FROM CORE_FSSC.CURATED_ORDERS.ORDER_DELIVERY_HISTORY
UNION 
SELECT 
  ORDER_ID 
, STORE_NBR 
, ORDER_STATUS_CD 
, REC_EFF_TS 
FROM CORE_FSSC.CURATED_ORDERS.ORDER_DELIVERY
) AS C
ON A.ORDER_ID = C.ORDER_ID 
AND A.STORE_NBR = C.STORE_NBR 
where A.REC_EFF_TS >= current_date - 1000
and oms_order_nbr in (Select order_no from Store_Ops_SDD_orders)
and order_type = 15
GROUP BY ALL);

Create or replace table DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_SDD_orders_action_times as
(Select 
Order_no
, order_date
, RECALCULATED_STORE_SLA
, RECALCULATED_CUSTOMER_SLA
, Store_Order_Recv_Dt
, Pack_End_Date
, delivered_ts as Courier_Delivered
, picked_up_ts as Courier_Picked_Up
, return_to_store_ts as Courier_Return_To_Store
, Handoff_Date
, COURIER_FAILURE_REASON
, DATEDIFF(MINUTE, Store_Order_Recv_Dt, RECALCULATED_STORE_SLA) AS Time_to_pack
, coalesce(Pack_End_Date,Cancelled_Date) as Actioned_Time
, case when RECALCULATED_STORE_SLA >= Actioned_Time then 1
  when RECALCULATED_STORE_SLA < Actioned_Time then 0 
  else null end as Actioned_on_time
from 
(select SOH.order_no as order_no
, to_date(order_date) as Order_date
, max(SHE.COURIER_FAILURE_REASON_CODE) as COURIER_FAILURE_REASON
, max(EXPECTED_SHIPMENT_DATE) as  RECALCULATED_STORE_SLA
, max(SOH.EXPECTED_DELIVERY_DATE) as RECALCULATED_CUSTOMER_SLA
, max(case when ca.activity_code in ('Delivered') and ca.activity_time_stamp is not null then ca.activity_time_stamp end ) as delivered_ts
, max(case when ca.activity_code in ('Picked Up') and ca.activity_time_stamp is not null then ca.activity_time_stamp end) as  picked_up_ts
, max(case when ca.activity_code in ('Returned To Store', 'Return to Store', 'ReturnedToStore') and ca.activity_time_stamp is not null then ca.activity_time_stamp end) as return_to_store_ts
from "CORE_FSSC"."CURATED_OMS"."YFS_SHIPMENT_LINE" SOL
left join "CORE_FSSC"."CURATED_OMS"."YFS_SHIPMENT" SOH
on SOL.shipment_key = SOH.shipment_key
left join "CORE_FSSC"."CURATED_OMS"."YFS_CVS_SHIPMENT_EXTN" SHE
on SOH.shipment_key = try_to_number(SHE.SHIPMENT_KEY)
left join "CORE_FSSC"."CURATED_OMS"."YFS_CONTAINER_ACTIVITY" CA
on SOH.shipment_key = CA.shipment_key
left join "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_LINE" pol
on SOL.order_line_key = pol.order_line_key 
left join "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_LINE_EXTENSION" OLE 
on pol.order_line_key = ole.order_line_key
left join "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_HEADER" poh
on poh.order_header_key = pol.order_header_key
where pol.delivery_code = 'SDD'
and Year(to_date(order_date)) >= Year(current_date) - 2
group by 1,2) a
left join
(Select
OMS_ORDER_NBR
,max(Store_Order_Recv_Dt) Store_Order_Recv_Dt
,max(Pack_End_Date) Pack_End_Date
,max(HANDOFF_DATE) as Handoff_Date
,max(Cancelled_Date) Cancelled_Date
from
(Select
to_char(OMS_ORDER_NBR) as OMS_ORDER_NBR
,to_date(d.order_date) order_dt
--,case when ordr_dlvry_stus_ts_date - order_dt between -1 and 30 then c.ordr_dlvry_stus_ts else null end as ordr_dlvry_stus_ts_within_30_days
, max(b.ORDER_DATE) as Store_Order_Recv_Dt
, max(PREP_DATE) as Pack_End_Date
, max(HANDOFF_DATE) as Handoff_Date
, max(Cancelled_Date) Cancelled_Date
from (select * from SDD_Order_Timestamps) b
left join "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_HEADER" d
on b.OMS_ORDER_NBR = d.order_no
where order_no in (Select Order_no from Store_Ops_SDD_orders group by 1)
group by all) a
group by 1) b
on a.order_no = b.OMS_ORDER_NBR
);

Create or replace table DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_SDD_Order_flags as 
(
Select 
a.order_no
, to_date(Actioned_Time) as Actioned_Date
, Order_date
, case when b.order_no is not null then 1 else 0 end as canceled_orders
, case when c.order_no is not null then 1 else 0 end as Handoff_Missed
, case when Actioned_on_time = 1 then 1 else 0 end as actioned_on_time
, original_ordered_qty
, SHIPPED_QUANTITY
from Store_Ops_SDD_orders a
left join (Select order_no from DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_SDD_order_cancel_reasons where Cancellation_Type = 'Colleague_Cancelled' group by 1) b
on a.order_no = b.order_no
left join (Select order_no from DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_SDD_order_cancel_reasons where Cancellation_Type = 'Handoff_Miss' group by 1) c
on a.order_no = c.order_no
left join DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_SDD_orders_action_times d
on a.order_no = d.order_no
where RECALCULATED_STORE_SLA is not null --orders_with_slas
and Actioned_Time is not null --Orders that were actioned
and (Case when actioned_on_time = 0 and Time_to_pack < 65 then 1 else 0 end) = 0 --orders with enough time to pack
);

--Sample end result query
/*Select 
b.store_nbr
, b.Division
, b.Region
, b.District
, count(distinct a.order_no)
, sum(a.canceled_orders)
, sum(a.actioned_on_time)
from DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_SDD_Order_flags a
left join Store_Ops_SDD_Order_DRD b
on a.order_no = b.order_no
where order_date = '2025-06-01'
group by 1,2,3,4;*/

Create or replace temporary table Store_Ops_BOPIS_orders as
(Select order_no, 
Case when entry_type in ('COVID_KIT','COVID_CHECKOUT') then 'COVID_KIT'
when entry_type in ('COVID_ADJ_FLOW') then entry_type 
when Order_type = 'NONRX' then 'BOPIS'
when Order_type = 'BOPUS' then 'BOPIS'
else Order_type end as Order_type
, sum(original_ordered_qty) original_ordered_qty
, sum(SHIPPED_QUANTITY) SHIPPED_QUANTITY
from "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_HEADER" poh
inner join "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_LINE" pol
on poh.order_header_key = pol.order_header_key
where poh.entry_type in  ('ATGCSC','CVS.COM','COVID_KIT','COVID_CHECKOUT', 'COVID_ADJ_FLOW')
and poh.document_type in ('0001')
and pol.Line_Type = 'BOPUS'
and Year(to_date(order_date)) >= Year(current_date) - 3
group by 1,2);

Create or replace temporary table Store_Ops_BOPIS_lines as
(Select Order_line_key as Order_line_key
, Case when entry_type in ('COVID_KIT','COVID_CHECKOUT') then 'COVID_KIT'
when entry_type in ('COVID_ADJ_FLOW') then entry_type 
when Order_type = 'NONRX' then 'BOPIS'
when Order_type = 'BOPUS' then 'BOPIS'
else Order_type end as Order_type
from  "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_HEADER" poh
inner join "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_LINE" pol
on poh.order_header_key = pol.order_header_key
where poh.entry_type in  ('ATGCSC','CVS.COM','COVID_KIT','COVID_CHECKOUT', 'COVID_ADJ_FLOW')
and poh.document_type in ('0001')
and pol.Line_Type = 'BOPUS'
and Year(to_date(order_date)) >= Year(current_date) - 3)
;

Create or replace table DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_BOPIS_Order_DRD as
(Select
trim(try_to_number(a.order_no)) as order_no
, trim(a.store_nbr) as store_nbr
, Division
, Region
, District
From
--Order stores
(Select 
Order_no
,try_to_number(shipnode_key) as store_nbr
from 
(Select 
a.Order_no as Order_no
, b.shipnode_key
from "CORE_FSSC"."CURATED_OMS"."YFS_SHIPMENT_LINE" a
left join "CORE_FSSC"."CURATED_OMS"."YFS_SHIPMENT" b
on a.SHIPMENT_KEY = b.SHIPMENT_KEY
where order_line_key in (Select Order_line_key from Store_Ops_BOPIS_lines)
and b.shipnode_key not like '%DC%'
)a
where shipnode_key not like '%DC%'
group by 1,2
) a
left join
--DRD
(Select 
store_nbr
, FS_AREA_NBR as Division
, FS_REGION_NBR as Region
, FS_DISTRICT_NBR as District
from "CORE_RX"."CURATED_LOCATION"."STORE") b
on a.store_nbr = b.store_nbr
where a.store_nbr not like '%DC%');

Create or replace temporary table Store_Ops_BOPIS_order_cancel_reasons as
(Select 
poh.order_no
,pol.order_line_key
,case 
when coalesce(pol.EXTN_CANCEL_DESC,s.extn_shipment_cancelled_reason) in ('Out of Stock','Damaged','Danaged','Item Expired','Store Cancelation','SKU is OOS','PNP Record Shortage','Partially Filled') then 'Colleague_Cancelled'	
when coalesce(pol.EXTN_CANCEL_DESC,s.extn_shipment_cancelled_reason) in ('Order Missing', 'Order is missing') then 'Handoff_Miss'
else 'Other' end as Cancellation_Type
,coalesce(pol.EXTN_CANCEL_DESC,s.extn_shipment_cancelled_reason) as cancellation_reason
,sum(original_ordered_qty) original_ordered_qty
,sum(SHIPPED_QUANTITY) SHIPPED_QUANTITY
from "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_HEADER" poh
left join "CORE_FSSC"."CURATED_OMS"."YFS_SHIPMENT" s
on poh.order_header_key = s.order_header_key
and s.extn_shipment_cancelled_reason is not null
inner join "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_LINE" pol
on poh.order_header_key = pol.order_header_key
where poh.order_no in (Select order_no from Store_Ops_BOPIS_orders)
and pol.line_type = 'BOPUS'
group by 1,2,3,4);

--Full or Partial
Create or replace temporary table Store_Ops_BOPIS_Full_Or_Partial as
(Select
a.Order_no
,Qty
,Canceled_QTY
, Case when Qty = Canceled_QTY then 'Full Cancelation'
	   when Qty <> Canceled_QTY then 'Partial Cancelation' 
	   end as "Full or Partial"
from
(--Number of line in an order
Select Order_no
, sum(original_ordered_qty) as Qty
,Count(distinct Order_line_key) as Lines
from  "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_HEADER" poh
inner join "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_LINE" pol
on poh.order_header_key = pol.order_header_key
where poh.entry_type in  ('ATGCSC','CVS.COM','COVID_KIT','COVID_CHECKOUT', 'COVID_ADJ_FLOW')
and poh.document_type in ('0001')
and pol.Line_Type = 'BOPUS'
and Year(to_date(order_date)) >= Year(current_date) - 3
group by 1) a
Full outer Join
(--Number of lines that are cancled
Select 
poh.order_no
, sum(original_ordered_qty) - sum(SHIPPED_QUANTITY) Canceled_QTY
from "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_HEADER" poh
left join "CORE_FSSC"."CURATED_OMS"."YFS_SHIPMENT" s
on poh.order_header_key = s.order_header_key
and s.extn_shipment_cancelled_reason is not null
inner join "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_LINE" pol
on poh.order_header_key = pol.order_header_key
where poh.order_no in (--BOPIS Orders
Select order_no
from  "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_HEADER" poh
inner join "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_LINE" pol
on poh.order_header_key = pol.order_header_key
where poh.entry_type in  ('ATGCSC','CVS.COM','COVID_KIT','COVID_CHECKOUT', 'COVID_ADJ_FLOW')
and poh.document_type in ('0001')
and pol.Line_Type = 'BOPUS'
and Year(to_date(order_date)) >= Year(current_date) - 3
group by 1)
and pol.line_type = 'BOPUS'
and coalesce(pol.EXTN_CANCEL_DESC,s.extn_shipment_cancelled_reason) in ('Out of Stock','Damaged','Danaged','Item Expired','Store Cancelation','SKU is OOS','PNP Record Shortage','Partially Filled')
group by 1) b
on a.Order_no = b.order_no
where Canceled_QTY is not null);

Create or replace temporary table Store_Ops_BOPIS_Category_cancelations as
(Select 
poh.order_no
, pol.order_line_key
, item_id
, cat_dsc
, mdse_grp_dsc
--, ordered_qty
, original_ordered_qty --Demand
,coalesce(pol.EXTN_CANCEL_DESC,s.extn_shipment_cancelled_reason) as cancellation_reason
from "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_HEADER" poh
left join "CORE_FSSC"."CURATED_OMS"."YFS_SHIPMENT" s
on poh.order_header_key = s.order_header_key
and s.extn_shipment_cancelled_reason is not null
inner join "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_LINE" pol
on poh.order_header_key = pol.order_header_key
left join "PROD_COMM_DB"."CDP_APP"."SKU_MF" SKU
ON pol.ITEM_ID = SKU.SKU_NBR
where poh.order_no in (--BOPIS Orders
Select order_no
from  "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_HEADER" poh
inner join "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_LINE" pol
on poh.order_header_key = pol.order_header_key
where poh.entry_type in ('ATGCSC','CVS.COM','COVID_KIT','COVID_CHECKOUT', 'COVID_ADJ_FLOW')
and poh.document_type in ('0001')
and pol.Line_Type = 'BOPUS'
and Year(to_date(order_date)) >= Year(current_date) - 3
group by 1)
and pol.line_type = 'BOPUS'
and coalesce(pol.EXTN_CANCEL_DESC,s.extn_shipment_cancelled_reason) in ('Out of Stock','Damaged','Danaged','Item Expired','Store Cancelation','SKU is OOS','PNP Record Shortage','Partially Filled')
);

CREATE OR REPLACE TEMPORARY TABLE BOPIS_Order_Timestamps AS (
SELECT 
  B.RX_NBR 
, B.STORE_NBR 
, B.FILL_NBR 
, A.OMS_ORDER_NBR
, delivery_sla_cd
, MAX(CASE WHEN C.ORDER_STATUS_CD = 10 THEN C.REC_EFF_TS ELSE NULL END) AS ORDER_DATE 
, MAX(CASE WHEN C.ORDER_STATUS_CD = 2 THEN C.REC_EFF_TS ELSE NULL END) AS PREP_DATE
, MAX(CASE WHEN C.ORDER_STATUS_CD in (26,13) THEN C.REC_EFF_TS ELSE NULL END) AS HANDOFF_DATE
, MAX(CASE WHEN C.ORDER_STATUS_CD = 4 THEN C.REC_EFF_TS ELSE NULL END) AS DELIVERED_DATE
, MAX(CASE WHEN C.ORDER_STATUS_CD = 8 THEN C.REC_EFF_TS ELSE NULL END) AS CANCELLED_DATE
, MAX(CASE WHEN C.ORDER_STATUS_CD = 14 THEN C.REC_EFF_TS ELSE NULL END) AS ATTEMPTED_DELIVERY 
, MAX(CASE WHEN C.ORDER_STATUS_CD = 20 THEN C.REC_EFF_TS ELSE NULL END) AS HANDOFF_FAILURE
, MAX(CASE WHEN C.ORDER_STATUS_CD = 5  THEN C.REC_EFF_TS ELSE NULL END) AS Courier_Return_Date_PNP
FROM CORE_FSSC.CURATED_ORDERS.ORDER_DELIVERY AS A 
JOIN CORE_FSSC.CURATED_ORDERS.ORDER_DELIVERY_ITEM AS B
ON A.ORDER_ID = B.ORDER_ID
AND A.STORE_NBR = B.STORE_NBR
--Used to remove mismatched timestamps?
JOIN (
  SELECT 
  ORDER_ID 
, STORE_NBR 
, ORDER_STATUS_CD 
, REC_EFF_TS 
FROM CORE_FSSC.CURATED_ORDERS.ORDER_DELIVERY_HISTORY
UNION 
SELECT 
  ORDER_ID 
, STORE_NBR 
, ORDER_STATUS_CD 
, REC_EFF_TS 
FROM CORE_FSSC.CURATED_ORDERS.ORDER_DELIVERY
) AS C
ON A.ORDER_ID = C.ORDER_ID 
AND A.STORE_NBR = C.STORE_NBR 
where A.REC_EFF_TS >= current_date - 1000
and oms_order_nbr in (Select order_no from Store_Ops_BOPIS_orders)
and order_type = 15
GROUP BY ALL);

Create or replace table DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_BOPIS_orders_action_times as 
(Select 
Order_no
, Extn_estimated_wait_time
, Store_Order_Recv_Dt
,TIMESTAMPDIFF(MINUTE, Store_Order_Recv_Dt, EXTN_ESTIMATED_WAIT_TIME) AS Time_to_pack
, to_date(order_date) as order_date
, coalesce(Pack_End_Date,Cancelled_Date) as Actioned_Time
, case when Extn_estimated_wait_time >= Actioned_Time then 1
when Extn_estimated_wait_time < Actioned_Time then 0 
else 'Actioned time or sla is null' end as Actioned_on_time
from 
(select poh.order_date 
, poh.order_no
, max(case when pol.EXTN_ESTIMATED_WAIT_TIME_STZ is null then ole.Extn_estimated_wait_time else pol.EXTN_ESTIMATED_WAIT_TIME_STZ end) as EXTN_ESTIMATED_WAIT_TIME
from "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_HEADER" poh
inner join "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_LINE" pol 
on poh.order_header_key = pol.order_header_key
inner join "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_LINE_EXTENSION" ole
on pol.order_line_key = to_number(ole.order_line_key)
where ole.EXTN_ESTIMATED_WAIT_TIME is not null
and pol.Line_Type = 'BOPUS'
and Year(to_date(order_date)) >= Year(current_date) - 3
group by 1,2) a
Full outer join
(Select
OMS_ORDER_NBR
,max(Store_Order_Recv_Dt) Store_Order_Recv_Dt
,max(Pack_End_Date) Pack_End_Date
,max(Cancelled_Date) Cancelled_Date
from
(Select
OMS_ORDER_NBR
, to_date(d.order_date) order_dt
, max(b.order_date) Store_Order_Recv_Dt
, max(PREP_DATE) Pack_End_Date
, max(CANCELLED_DATE) Cancelled_Date
from (select * from BOPIS_Order_Timestamps)b
left join "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_HEADER" d
on b.OMS_ORDER_NBR = d.order_no
where OMS_ORDER_NBR in (select order_no from Store_Ops_BOPIS_orders)
group by all) a
group by 1) b
on a.order_no = b.OMS_ORDER_NBR
where Extn_estimated_wait_time is not null
and Actioned_Time is not null);

Create or replace table DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_BOPIS_Order_flags as 
(Select 
a.order_no as Order_no
, order_date
, to_date(Actioned_Time) as Actioned_date
, order_type
, case when b.order_no is not null then 1 else 0 end as canceled_orders
, case when c.order_no is not null then 1 else 0 end as Handoff_missed
, case when Actioned_on_time = 1 then 1 else 0 end as actioned_on_time
, original_ordered_qty
, SHIPPED_QUANTITY
from Store_Ops_BOPIS_orders a

left join (Select order_no
from Store_Ops_BOPIS_order_cancel_reasons 
where Cancellation_Type = 'Colleague_Cancelled'
group by 1) b
on a.order_no = b.order_no

left join (Select order_no
from Store_Ops_BOPIS_order_cancel_reasons 
where Cancellation_Type = 'Handoff_Miss'
group by 1) c
on a.order_no = c.order_no

left join DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_BOPIS_orders_action_times d
on a.order_no = d.order_no

where EXTN_ESTIMATED_WAIT_TIME is not null --orders_with_slas
and (Case when actioned_on_time = 0 and Time_to_pack < 55 then 1 else 0 end) = 0 --orders with enough time to pack
);

Create or replace table DL_RX_OPERATION.RX_OPS_SANDBOX.BOPIS_SDD_ORDERS as
(Select
store_nbr
,Program
,actioned_date
,b.fiscal_week_nbr as Fiscal_Week_nbr
,b.fiscal_month_nbr
,sum(Orders) as Orders
,sum(actioned_on_time) as Processed_On_Time
,sum(original_ordered_qty) as Total_units
,sum(a.SHIPPED_QUANTITY)   as Units_canceled
,sum(Handoff_missed) as Handoff_Miss
from
(Select 
'Splitcart' as Program
, c.store_nbr as store_nbr
, a.actioned_date
, count(distinct a.order_no) Orders
, sum(a.original_ordered_qty) original_ordered_qty
, sum(case when a.canceled_orders = 1 then a.original_ordered_qty - a.SHIPPED_QUANTITY  else 0 end) SHIPPED_QUANTITY
, sum(Case when a.actioned_on_time = 1 and b.actioned_on_time = 1 then 1 else 0 end) as actioned_on_time
, sum(b.Handoff_missed) Handoff_missed
from DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_SDD_Order_flags a
inner join DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_BOPIS_Order_flags b
on a.order_no = b.order_no
left join DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_BOPIS_Order_DRD c
on a.order_no = c.order_no
where a.order_no||store_nbr not in (Select order_no||Shipnode_key from "APP_FSW"."SL_FSW_RPT"."SFS_EXLUSIONS_FSWF")
and a.order_no not in (
  Select OMS_ORDER_NBR from CORE_FSSC.CURATED_ORDERS.ORDER_DELIVERY where destination_recipient_txt in ('reject reject','CVS MobileTest')
  UNION
  Select OMS_ORDER_NBR from CORE_FSSC.CURATED_ORDERS.ORDER_DELIVERY_HISTORY where destination_recipient_txt in ('reject reject','CVS MobileTest')
  )
group by all

Union

Select
'SDD' as Program
, b.store_nbr as store_nbr
, a.actioned_date
, count(distinct a.order_no) Orders
, sum(original_ordered_qty) original_ordered_qty
, sum(case when a.canceled_orders = 1 then a.original_ordered_qty - a.SHIPPED_QUANTITY else 0 end) SHIPPED_QUANTITY
, sum(a.actioned_on_time) actioned_on_time
, sum(Handoff_missed) as Handoff_missed
from DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_SDD_Order_flags a
left join Store_Ops_SDD_Order_DRD b
on a.order_no = b.order_no

left join "CORE_FSSC"."CURATED_CALENDAR"."DAY"
on date_dt = actioned_date

where a.order_no not in (Select a.order_no
from DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_SDD_Order_flags a
inner join DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_BOPIS_Order_flags b
on a.order_no = b.order_no)
and a.order_no||store_nbr not in (Select order_no||Shipnode_key from "APP_FSW"."SL_FSW_RPT"."SFS_EXLUSIONS_FSWF")
and a.order_no not in (
  Select OMS_ORDER_NBR from CORE_FSSC.CURATED_ORDERS.ORDER_DELIVERY where destination_recipient_txt in ('reject reject','CVS MobileTest')
  UNION
  Select OMS_ORDER_NBR from CORE_FSSC.CURATED_ORDERS.ORDER_DELIVERY_HISTORY where destination_recipient_txt in ('reject reject','CVS MobileTest')
  )
group by all

Union

Select 
'BOPIS' as Program
, b.store_nbr as store_nbr
, a.actioned_date
, count(distinct a.order_no) Orders
, sum(original_ordered_qty) original_ordered_qty
, sum(case when a.canceled_orders = 1 then a.original_ordered_qty - a.SHIPPED_QUANTITY else 0 end) SHIPPED_QUANTITY
, sum(a.actioned_on_time) actioned_on_time
, sum(Handoff_missed) Handoff_missed
from DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_BOPIS_Order_flags a
left join DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_BOPIS_Order_DRD b
on a.order_no = b.order_no

left join "CORE_FSSC"."CURATED_CALENDAR"."DAY"
on date_dt = actioned_date
where a.order_no not in (Select a.order_no
from DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_SDD_Order_flags a
inner join DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_BOPIS_Order_flags b
on a.order_no = b.order_no)
and a.order_no||store_nbr not in (Select order_no||Shipnode_key from "APP_FSW"."SL_FSW_RPT"."SFS_EXLUSIONS_FSWF")
and a.order_no not in (
  Select OMS_ORDER_NBR from CORE_FSSC.CURATED_ORDERS.ORDER_DELIVERY where destination_recipient_txt in ('reject reject','CVS MobileTest')
  UNION
  Select OMS_ORDER_NBR from CORE_FSSC.CURATED_ORDERS.ORDER_DELIVERY_HISTORY where destination_recipient_txt in ('reject reject','CVS MobileTest')
  )
group by all) a

left join "CORE_FSSC"."CURATED_CALENDAR"."DAY" b
on date_dt = actioned_date
where fiscal_year_nbr >= (Select fiscal_year_nbr
from "CORE_FSSC"."CURATED_CALENDAR"."DAY" 
where date_dt = current_date -720)
group by all);

CREATE OR REPLACE TEMPORARY TABLE "SFS_ORDERS_AND_DETAILS" as (
SELECT
ol.order_line_key
,ol.order_header_key
,ors.order_release_key
,orl.shipnode_key
,oh.order_date
,oh.order_no
,Nvl(Max(CASE when ors.status = 1400 and status_quantity > 0 and ors.createuserid = 'CVSRerouteOrderAgentServer' THEN oh.order_no ELSE NULL end),0) resourced_orders --This is the time an order is visable in PnP
,Nvl(Max(CASE WHEN ors.status = '3200' THEN ors.total_quantity ELSE NULL end),0) released_qty
,Nvl(Max(CASE WHEN ors.status = '3350.3000' THEN ors.total_quantity ELSE NULL end),0) packed_qty
,Nvl(Max(CASE WHEN ors.status = '3700' THEN ors.total_quantity ELSE NULL end),0) manifested_qty
,Nvl(Max(CASE WHEN ors.status = '3700' THEN ol.line_total ELSE NULL end),0) manifested_sales
,Nvl(Max(CASE WHEN ors.status = '1400' AND ors.createprogid NOT IN ('Console','SterlingHttpTester') THEN ors.total_quantity ELSE 0 end),0)  units_skipped_by_node
,Max(CASE WHEN ors.status = '3200' THEN ors.status_date ELSE NULL end) released_timestamp --This is the time an order is assigned to the store by OMS
,Max(CASE WHEN ors.status = '3350.2000' THEN ors.status_date ELSE NULL end) ready_for_packing_timestamp --This is the time an order is visable in PnP
,Max(CASE WHEN ors.status = '3350.3000' THEN ors.status_date ELSE NULL end) packed_timestamp --What does this represent (Does it mean that all lines are addressed?)
,Max(CASE WHEN ors.status = '3700' THEN ors.status_date ELSE NULL end) manifested_timestamp
,Max(CASE WHEN ors.status = '1400' THEN ors.status_date ELSE NULL end) skipped_timestamp
,Max(CASE WHEN ors.status = '9000' THEN ors.status_date ELSE NULL end) canceled_timestamp
FROM "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_LINE" ol
LEFT OUTER JOIN "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_HEADER" oh
ON oh.order_header_key = ol.order_header_key
LEFT OUTER JOIN "CORE_FSSC"."CURATED_OMS"."YFS_CVS_ORDER_EXTENSION" oe
ON oe.order_header_key = oh.order_header_key
LEFT OUTER JOIN "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_RELEASE_STATUS" ors
ON ors.order_line_key = ol.order_line_key
AND ors.status IN ('1400','3200','3350.2000','3300','3350.3000','3700','9000') --1400 bounced/skipped, 3200 released, 3300 sent to node, 3350.2000 ready for packing, 3350.3000 packed, 3700 manisfested/shipped, 9000 canceled
LEFT OUTER JOIN "CORE_FSSC"."CURATED_OMS"."YFS_ORDER_RELEASE" orl
ON orl.order_release_key = ors.order_release_key
LEFT OUTER JOIN "CORE_FSSC"."CURATED_OMS"."YFS_SHIPMENT" s
ON s.order_header_key = oh.order_header_key
WHERE oh.entry_type IN ('OrderGroove','CVS.COM','ATGCSC','otchsOrder')
and oh.document_type in ('0001')
and ol.delivery_code is null --removes SDD data
and s.shipment_type in ('SFS','SFSP','OTCHS')
GROUP BY ALL);

CREATE OR REPLACE TEMPORARY TABLE "ADJUSTED_TIME_STAMPS" as (
Select
order_no
, order_line_key
, shipnode_key
--Unit fill rate
, released_qty
, units_skipped_by_node
--Processed on time
, resourced_orders
, coalesce(packed_timestamp,skipped_timestamp) as actioned_timestamp --must be actioned by 8pm
, case when manifested_qty > 0 then manifested_sales else 0 end as manifested_sales

,CASE
WHEN Trim(str_timezone) = 'CT' THEN released_timestamp - INTERVAL '1 HOUR' 
WHEN Trim(str_timezone) = 'MT' THEN released_timestamp - INTERVAL '2 HOUR'
WHEN Trim(str_timezone) = 'PT' THEN released_timestamp - INTERVAL '3 HOUR'
WHEN Trim(str_timezone) = 'HT' THEN released_timestamp - INTERVAL '6 HOUR'
ELSE released_timestamp END AS adj_release_timestamp

,To_date(CASE
WHEN Trim(str_timezone) = 'CT' THEN released_timestamp - INTERVAL '1 HOUR' 
WHEN Trim(str_timezone) = 'MT' THEN released_timestamp - INTERVAL '2 HOUR'
WHEN Trim(str_timezone) = 'PT' THEN released_timestamp - INTERVAL '3 HOUR'
WHEN Trim(str_timezone) = 'HT' THEN released_timestamp - INTERVAL '6 HOUR'
ELSE released_timestamp END) AS adj_release_date

,CASE
WHEN Trim(str_timezone) = 'CT' THEN ready_for_packing_timestamp - INTERVAL '1 HOUR' 
WHEN Trim(str_timezone) = 'MT' THEN ready_for_packing_timestamp - INTERVAL '2 HOUR'
WHEN Trim(str_timezone) = 'PT' THEN ready_for_packing_timestamp - INTERVAL '3 HOUR'
WHEN Trim(str_timezone) = 'HT' THEN ready_for_packing_timestamp - INTERVAL '6 HOUR'
ELSE ready_for_packing_timestamp END AS adj_ready_for_packing_timestamp

,To_date(CASE
WHEN Trim(str_timezone) = 'CT' THEN ready_for_packing_timestamp - INTERVAL '1 HOUR' 
WHEN Trim(str_timezone) = 'MT' THEN ready_for_packing_timestamp - INTERVAL '2 HOUR'
WHEN Trim(str_timezone) = 'PT' THEN ready_for_packing_timestamp - INTERVAL '3 HOUR'
WHEN Trim(str_timezone) = 'HT' THEN ready_for_packing_timestamp - INTERVAL '6 HOUR'
ELSE ready_for_packing_timestamp END) AS adj_ready_for_packing_date

,To_date(CASE
WHEN Trim(str_timezone) = 'CT' THEN actioned_timestamp - INTERVAL '1 HOUR'
WHEN Trim(str_timezone) = 'MT' THEN actioned_timestamp - INTERVAL '2 HOUR'
WHEN Trim(str_timezone) = 'PT' THEN actioned_timestamp - INTERVAL '3 HOUR'
WHEN Trim(str_timezone) = 'HT' THEN actioned_timestamp - INTERVAL '6 HOUR'
ELSE actioned_timestamp END) AS adj_actioned_date

,CASE WHEN HOUR(adj_ready_for_packing_timestamp) >= 15 THEN to_date(adj_ready_for_packing_timestamp) + INTERVAL '1 DAY' else to_date(adj_ready_for_packing_timestamp) END AS Due_dttm
,CASE WHEN adj_actioned_date <= due_dttm THEN 1 ELSE 0 END AS actioned_on_time
from "SFS_ORDERS_AND_DETAILS" a
left join "PL_APP_SCAI"."SCAI_FS"."OMS_NODE_INFO" b
on a.shipnode_key = to_char(b.store_nbr)
where shipnode_key in (Select to_char(store_nbr) from "PL_APP_SCAI"."SCAI_FS"."OMS_NODE_INFO" where (NODE_TYPE = 'Store' or NODE_TYPE is null)) --SFS Store list
and Year(to_date(order_date)) >= Year(CURRENT_DATE)-1 -- limiting to last two years
and order_no||Shipnode_key not in (Select order_no||Shipnode_key from "APP_FSW"."SL_FSW_RPT"."SFS_EXLUSIONS_FSWF")--Exclusion table is to be added here
);

--select * from "ADJUSTED_TIME_STAMPS" limit 10;
--select * from DL_RX_OPERATION.RX_OPS_SANDBOX.OUTPUT_PREP limit 10;

CREATE OR REPLACE TABLE DL_RX_OPERATION.RX_OPS_SANDBOX.OUTPUT_PREP as (
Select
order_no
, shipnode_key
, resourced_orders
, count(distinct order_line_key) lines
, max(Due_dttm) as Due_dttm --This controls for multi due date orders. If an order has multiple shipnode/due_date combonations then the first due date is when the order is added to the data.
--Unit fill rate
, sum(manifested_sales) as manifested_sales
, sum(released_qty) as released_qty
, sum(units_skipped_by_node) as units_skipped_by_node
, CASE WHEN sum(actioned_on_time) = count(order_line_key) then 1 else 0 end as actioned_one_time
from "ADJUSTED_TIME_STAMPS"
where adj_ready_for_packing_timestamp is not null
group by all);

CREATE OR REPLACE TEMPORARY TABLE SFS_Orders as (
select
SHIPNODE_KEY as store_nbr
,'SFS' as Program
,Due_dttm as actioned_date
,fiscal_week_nbr
,Fiscal_month_nbr
,count(distinct(resourced_orders)) as resourced_orders
,count(distinct order_no) as Orders
,count(distinct(case when actioned_one_time = 1 then order_no end)) Processed_On_Time
,sum(released_qty) as Total_units
,sum(units_skipped_by_node) Units_canceled
,null as Handoff_missed
from DL_RX_OPERATION.RX_OPS_SANDBOX.OUTPUT_PREP a
left join CORE_FSSC.CURATED_CALENDAR.DAY b
on a.Due_dttm = b.date_dt
group by all);

CREATE OR REPLACE TABLE DL_RX_OPERATION.RX_OPS_SANDBOX.OF_Orders as (
Select STORE_NBR 
,PROGRAM 
,ACTIONED_DATE 
,FISCAL_WEEK_NBR 
,FISCAL_MONTH_NBR 
,ORDERS	
,PROCESSED_ON_TIME 
,TOTAL_UNITS 
,UNITS_CANCELED	
,HANDOFF_MISSED 
from SFS_Orders 
Union 
Select * from DL_RX_OPERATION.RX_OPS_SANDBOX.BOPIS_SDD_ORDERS
UNION
Select
STORE_NBR
,'ALL' as Program
, actioned_date
, fiscal_week_nbr
, fiscal_month_nbr
, sum(Orders) as Orders
, sum(Processed_On_Time) as Processed_On_Time
, sum(Total_units) as Total_units
, sum(Units_canceled) as Units_canceled
, sum(Handoff_Missed) as Handoff_Missed
from
(Select STORE_NBR	
,PROGRAM	
,ACTIONED_DATE	
,FISCAL_WEEK_NBR	
,FISCAL_MONTH_NBR	
,ORDERS	
,PROCESSED_ON_TIME	
,TOTAL_UNITS	
,UNITS_CANCELED	
,HANDOFF_MISSED from SFS_Orders 
Union
Select * from DL_RX_OPERATION.RX_OPS_SANDBOX.BOPIS_SDD_ORDERS)a
group by all);

CREATE OR REPLACE TABLE DL_RX_OPERATION.RX_OPS_SANDBOX.OF_DRD as (
Select 
to_char(to_number(A.STORE_NBR)) as STORE_NBR
, to_char(to_number(B.FS_AREA_NBR)) as FS_AREA_NBR
, to_char(to_number(B.FS_REGION_NBR)) as FS_REGION_NBR
, to_char(to_number(B.FS_DISTRICT_NBR)) as FS_DISTRICT_NBR
, Program
, actioned_date
, fiscal_week_nbr
, fiscal_month_nbr
, sum(Orders) as Orders
, sum(Processed_On_Time) as Processed_On_Time
, sum(Total_units) as Total_units
, sum(Units_canceled) as Units_canceled
, sum(Handoff_Missed) as Handoff_Missed
from DL_RX_OPERATION.RX_OPS_SANDBOX.OF_Orders a
left join "CORE_FSSC"."CURATED_LOCATION"."STORE" b
on a.store_nbr = b.store_nbr
group by all);

CREATE OR REPLACE TEMPORARY TABLE OF_ROLLUPS_TIMEFRAMES as (

Select
  coalesce(a.STORE_NBR,c.STORE_NBR) as STORE_NBR
, coalesce(a.FS_AREA_NBR,c.FS_AREA_NBR) as FS_AREA_NBR
, coalesce(a.FS_REGION_NBR,c.FS_REGION_NBR) as FS_REGION_NBR
, coalesce(a.FS_DISTRICT_NBR,c.FS_DISTRICT_NBR) as FS_DISTRICT_NBR
, coalesce(a.Program,c.Program) as Program

, LW_Orders
, LW_Processed_On_Time
, LW_Total_units
, LW_Units_canceled
, LW_Handoff_Missed 

, LM_Orders
, LM_Processed_On_Time
, LM_Total_units
, LM_Units_canceled
, LM_Handoff_Missed 
, OFH
, OFH_SCORE

, YTD_Orders
, YTD_Processed_On_Time
, YTD_Total_units
, YTD_Units_canceled
, YTD_Handoff_Missed 

from
(Select 
STORE_NBR
, FS_AREA_NBR
, FS_REGION_NBR
, FS_DISTRICT_NBR
, Program
, sum(Orders) as YTD_Orders
, sum(Processed_On_Time) as YTD_Processed_On_Time
, sum(Total_units) as YTD_Total_units
, sum(Units_canceled) as YTD_Units_canceled
, sum(Handoff_Missed) as YTD_Handoff_Missed 
from DL_RX_OPERATION.RX_OPS_SANDBOX.OF_DRD 
where fiscal_month_nbr between
(Select to_number(left(min(Fiscal_month_nbr),4) || '01')
from "CORE_FSSC"."CURATED_CALENDAR"."DAY"
where date_dt between current_date - 30 and current_date)
and 
(Select min(Fiscal_month_nbr)
from "CORE_FSSC"."CURATED_CALENDAR"."DAY"
where date_dt between current_date - 35 and current_date)
group by all)a

Full outer join

(Select 
STORE_NBR
, FS_AREA_NBR
, FS_REGION_NBR
, FS_DISTRICT_NBR
, Program
, sum(Orders) as LM_Orders
, sum(Processed_On_Time) as LM_Processed_On_Time
, sum(Total_units) as LM_Total_units
, sum(Units_canceled) as LM_Units_canceled
, sum(Handoff_Missed) as LM_Handoff_Missed 
, case when sum(Handoff_Missed) is null then (.5 * (1-(sum(Units_canceled)/sum(Total_units)))) + (.5 * (sum(Processed_On_Time)/sum(Orders)))
else (.45 * (sum(Processed_On_Time)/sum(Orders))) + (.45 * (1-(sum(Units_canceled)/sum(Total_units)))) + (.1 * (1-(sum(Handoff_Missed)/sum(ORDERS))))
end as OFH
, Case when OFH >= .94 then 'Healthy'
when OFH >= .90 then 'Opportunity'
else 'At Risk' end as OFH_Score
from DL_RX_OPERATION.RX_OPS_SANDBOX.OF_DRD 
where fiscal_month_nbr = (Select min(Fiscal_month_nbr)
from "CORE_FSSC"."CURATED_CALENDAR"."DAY"
where date_dt between current_date - 35 and current_date)
group by all)b

on a.STORE_NBR = b.STORE_NBR
and a.FS_AREA_NBR = b.FS_AREA_NBR
and a.FS_REGION_NBR = b.FS_REGION_NBR
and a.FS_DISTRICT_NBR = b.FS_DISTRICT_NBR
and a.Program = b.Program

Full outer join

(Select 
STORE_NBR
, FS_AREA_NBR
, FS_REGION_NBR
, FS_DISTRICT_NBR
, Program
, sum(Orders) as LW_Orders
, sum(Processed_On_Time) as LW_Processed_On_Time
, sum(Total_units) as LW_Total_units
, sum(Units_canceled) as LW_Units_canceled
, sum(Handoff_Missed) as LW_Handoff_Missed 
from DL_RX_OPERATION.RX_OPS_SANDBOX.OF_DRD 
where fiscal_week_nbr = (Select Fiscal_week_nbr
from "CORE_FSSC"."CURATED_CALENDAR"."DAY"
where date_dt = current_date - 7)
group by all)c

on a.STORE_NBR = c.STORE_NBR
and a.FS_AREA_NBR = c.FS_AREA_NBR
and a.FS_REGION_NBR = c.FS_REGION_NBR
and a.FS_DISTRICT_NBR = c.FS_DISTRICT_NBR
and a.Program = c.Program
);

CREATE OR REPLACE TABLE DL_RX_OPERATION.RX_OPS_SANDBOX.OF_ROLLUPS_TIMEFRAMES_DRD as (
SELECT
Program
, FS_AREA_NBR
, FS_REGION_NBR
, FS_DISTRICT_NBR
, STORE_NBR

, LW_Orders
, LW_Processed_On_Time
, LW_Total_units
, LW_Units_canceled
, LW_Handoff_Missed 

, LM_Orders
, LM_Processed_On_Time
, LM_Total_units
, LM_Units_canceled
, LM_Handoff_Missed 
, OFH
, OFH_SCORE

, YTD_Orders
, YTD_Processed_On_Time
, YTD_Total_units
, YTD_Units_canceled
, YTD_Handoff_Missed 

FROM OF_ROLLUPS_TIMEFRAMES
group by all

UNION

SELECT

Program
, FS_AREA_NBR
, FS_REGION_NBR
, FS_DISTRICT_NBR
, 'ALL' as STORE_NBR

, sum(LW_Orders) as LW_Orders
, sum(LW_Processed_On_Time) as LW_Processed_On_Time
, sum(LW_Total_units) as LW_Total_units
, sum(LW_Units_canceled) as LW_Units_canceled
, sum(LW_Handoff_Missed) as LW_Handoff_Missed

, sum(LM_Orders) as LM_Orders
, sum(LM_Processed_On_Time) as LM_Processed_On_Time
, sum(LM_Total_units) as LM_Total_units
, sum(LM_Units_canceled) as LM_Units_canceled
, sum(LM_Handoff_Missed) as LM_Handoff_Missed

, nullifzero(Count(distinct case when OFH_Score = 'Healthy' then store_nbr else null end)) / nullifzero(Count(distinct store_nbr)) as FIELD_OFH
, case when FIELD_OFH >= .85 then 'Healthy' 
when FIELD_OFH >= .5 then 'Opportunity' 
when FIELD_OFH >= 0 then 'At Risk' 
else null end as OFH_Score

, sum(YTD_Orders) as YTD_Orders
, sum(YTD_Processed_On_Time) as YTD_Processed_On_Time
, sum(YTD_Total_units) as YTD_Total_units
, sum(YTD_Units_canceled) as YTD_Units_canceled
, sum(YTD_Handoff_Missed) as YTD_Handoff_Missed

FROM OF_ROLLUPS_TIMEFRAMES
group by all

UNION

SELECT
Program
, FS_AREA_NBR
, FS_REGION_NBR
, 'ALL' as FS_DISTRICT_NBR
, 'ALL' as STORE_NBR

, sum(LW_Orders) as LW_Orders
, sum(LW_Processed_On_Time) as LW_Processed_On_Time
, sum(LW_Total_units) as LW_Total_units
, sum(LW_Units_canceled) as LW_Units_canceled
, sum(LW_Handoff_Missed) as LW_Handoff_Missed

, sum(LM_Orders) as LM_Orders
, sum(LM_Processed_On_Time) as LM_Processed_On_Time
, sum(LM_Total_units) as LM_Total_units
, sum(LM_Units_canceled) as LM_Units_canceled
, sum(LM_Handoff_Missed) as LM_Handoff_Missed

, nullifzero(Count(distinct case when OFH_Score = 'Healthy' then store_nbr else null end)) / nullifzero(Count(distinct store_nbr)) as FIELD_OFH
, case when FIELD_OFH >= .85 then 'Healthy' 
when FIELD_OFH >= .5 then 'Opportunity' 
when FIELD_OFH >= 0 then 'At Risk' 
else null end as OFH_Score

, sum(YTD_Orders) as YTD_Orders
, sum(YTD_Processed_On_Time) as YTD_Processed_On_Time
, sum(YTD_Total_units) as YTD_Total_units
, sum(YTD_Units_canceled) as YTD_Units_canceled
, sum(YTD_Handoff_Missed) as YTD_Handoff_Missed

FROM OF_ROLLUPS_TIMEFRAMES
group by all

UNION

SELECT
Program
, FS_AREA_NBR
, 'ALL' as FS_REGION_NBR
, 'ALL' as FS_DISTRICT_NBR
, 'ALL' as STORE_NBR

, sum(LW_Orders) as LW_Orders
, sum(LW_Processed_On_Time) as LW_Processed_On_Time
, sum(LW_Total_units) as LW_Total_units
, sum(LW_Units_canceled) as LW_Units_canceled
, sum(LW_Handoff_Missed) as LW_Handoff_Missed

, sum(LM_Orders) as LM_Orders
, sum(LM_Processed_On_Time) as LM_Processed_On_Time
, sum(LM_Total_units) as LM_Total_units
, sum(LM_Units_canceled) as LM_Units_canceled
, sum(LM_Handoff_Missed) as LM_Handoff_Missed

, nullifzero(Count(distinct case when OFH_Score = 'Healthy' then store_nbr else null end)) / nullifzero(Count(distinct store_nbr)) as FIELD_OFH
, case when FIELD_OFH >= .85 then 'Healthy' 
when FIELD_OFH >= .5 then 'Opportunity' 
when FIELD_OFH >= 0 then 'At Risk' 
else null end as OFH_Score

, sum(YTD_Orders) as YTD_Orders
, sum(YTD_Processed_On_Time) as YTD_Processed_On_Time
, sum(YTD_Total_units) as YTD_Total_units
, sum(YTD_Units_canceled) as YTD_Units_canceled
, sum(YTD_Handoff_Missed) as YTD_Handoff_Missed

FROM OF_ROLLUPS_TIMEFRAMES
group by all

UNION

SELECT
Program
, 'CHAIN' as FS_AREA_NBR
, 'ALL' as FS_REGION_NBR
, 'ALL' as FS_DISTRICT_NBR
, 'ALL' as STORE_NBR

, sum(LW_Orders) as LW_Orders
, sum(LW_Processed_On_Time) as LW_Processed_On_Time
, sum(LW_Total_units) as LW_Total_units
, sum(LW_Units_canceled) as LW_Units_canceled
, sum(LW_Handoff_Missed) as LW_Handoff_Missed

, sum(LM_Orders) as LM_Orders
, sum(LM_Processed_On_Time) as LM_Processed_On_Time
, sum(LM_Total_units) as LM_Total_units
, sum(LM_Units_canceled) as LM_Units_canceled
, sum(LM_Handoff_Missed) as LM_Handoff_Missed

, nullifzero(Count(distinct case when OFH_Score = 'Healthy' then store_nbr else null end)) / nullifzero(Count(distinct store_nbr)) as FIELD_OFH
, case when FIELD_OFH >= .85 then 'Healthy' 
when FIELD_OFH >= .5 then 'Opportunity' 
when FIELD_OFH >= 0 then 'At Risk' 
else null end as OFH_Score

, sum(YTD_Orders) as YTD_Orders
, sum(YTD_Processed_On_Time) as YTD_Processed_On_Time
, sum(YTD_Total_units) as YTD_Total_units
, sum(YTD_Units_canceled) as YTD_Units_canceled
, sum(YTD_Handoff_Missed) as YTD_Handoff_Missed
FROM OF_ROLLUPS_TIMEFRAMES
group by all);

Create or replace table DL_RX_OPERATION.RX_OPS_SANDBOX.CFR_ROLLUPS_TIMEFRAMES_DRD as (
Select 
Division
,Region
,District
,Store_nbr
,SCORE
,BRKDWN as Health
from
(Select 
'CHAIN' as Division
,'ALL' as Region
,'ALL' as District
,'ALL' as Store_nbr
,.01 * HEALTH_PERCENT as SCORE

,Case when HEALTH_PERCENT >= 70 then 'Healthy'
when HEALTH_PERCENT <= 69.9999 and HEALTH_PERCENT >= 50 then 'Opportunity'
when HEALTH_PERCENT <= 49.9999 then 'At Risk'
else 'Excluded'
end as BRKDWN

from APP_FSW.SL_FSW_RPT.VW_FSW_SCORECARD_CHN_MTD
where  FOCUS_AREA_ID = 1
and METRIC_ID = 1
and prcs_frqncy = 'MONTHLY'
and PRCS_PRD = (SELECT max(PRCS_PRD) from "APP_FSW"."SL_FSW_RPT"."VW_FSW_SCORECARD_STR_MTD")

Union

Select 
to_char(Division) as Division
,'ALL' as Region
,'ALL' as District
,'ALL' as Store_nbr
,.01 * HEALTH_PERCENT as SCORE

,Case when HEALTH_PERCENT >= 70 then 'Healthy'
when HEALTH_PERCENT <= 69.9999 and HEALTH_PERCENT >= 50 then 'Opportunity'
when HEALTH_PERCENT <= 49.9999 then 'At Risk'
else 'Excluded'
end as BRKDWN

from APP_FSW.SL_FSW_RPT.VW_FSW_SCORECARD_DIV_MTD
where  FOCUS_AREA_ID = 1
and METRIC_ID = 1
and prcs_frqncy = 'MONTHLY'
and PRCS_PRD = (SELECT max(PRCS_PRD) from "APP_FSW"."SL_FSW_RPT"."VW_FSW_SCORECARD_STR_MTD")

Union

Select 
to_char(Division) as Division
,to_char(Region) as Region
,'ALL' as District
,'ALL' as Store_nbr
,.01 * HEALTH_PERCENT as SCORE

,Case when HEALTH_PERCENT >= 70 then 'Healthy'
when HEALTH_PERCENT <= 69.9999 and HEALTH_PERCENT >= 50 then 'Opportunity'
when HEALTH_PERCENT <= 49.9999 then 'At Risk'
else 'Excluded'
end as BRKDWN


from APP_FSW.SL_FSW_RPT.VW_FSW_SCORECARD_RGN_MTD
where  FOCUS_AREA_ID = 1
and METRIC_ID = 1
and prcs_frqncy = 'MONTHLY'
and PRCS_PRD = (SELECT max(PRCS_PRD) from "APP_FSW"."SL_FSW_RPT"."VW_FSW_SCORECARD_STR_MTD")

Union

Select 
to_char(Division) as Division
,to_char(Region) as Region
,to_char(District) as District
,'ALL' as Store_nbr
,.01 * HEALTH_PERCENT as SCORE

,Case when HEALTH_PERCENT >= 70 then 'Healthy'
when HEALTH_PERCENT <= 69.9999 and HEALTH_PERCENT >= 50 then 'Opportunity'
when HEALTH_PERCENT <= 49.9999 then 'At Risk'
else 'Excluded'
end as BRKDWN

from APP_FSW.SL_FSW_RPT.VW_FSW_SCORECARD_DSTR_MTD
where  FOCUS_AREA_ID = 1
and METRIC_ID = 1
and prcs_frqncy = 'MONTHLY'
and PRCS_PRD = (SELECT max(PRCS_PRD) from "APP_FSW"."SL_FSW_RPT"."VW_FSW_SCORECARD_STR_MTD")

Union

Select 
to_char(DIVISION) as  Division
,to_char(Region) as   Region
,to_char(District) as District
,to_char(Store_no) as Store_nbr
,CFR_PNTS_MNTHLY as SCORE
,Case when CFR_PNTS_MNTHLY >= .80 then 'Healthy'
when CFR_PNTS_MNTHLY >= .70 then 'Opportunity'
when CFR_PNTS_MNTHLY < .70 then 'At Risk' 
else 'Excluded'
end as BRKDWN
from APP_FSW.RL_FSW.RAW_FSW_CFR_DATA_MTD_YTD));

Create or replace temporary table CHRONIC_ACUTE as (
Select 
FS_AREA_NBR
,FS_REGION_NBR
,FS_DISTRICT_NBR
,STORE_NBR as STORE_NBR
,count(distinct Case when OFH >= .94 then fiscal_week_nbr else null end) as Weeks_Store_Healthy
,case when Weeks_Store_Healthy <= 3 then 'Chronic'
when Weeks_Store_Healthy <= 8 then 'Acute'
Else 'Healthy' end as "Acute_Chronic_Indicator"
from (Select 
FISCAL_WEEK_NBR
,FS_AREA_NBR
,FS_REGION_NBR
,FS_DISTRICT_NBR
,STORE_NBR as STORE_NBR
,case when sum(Handoff_Missed) is null then (.5 * (1-(sum(Units_canceled)/sum(Total_units)))) + (.5 * (sum(Processed_On_Time)/sum(Orders)))
else (.45 * (sum(Processed_On_Time)/sum(Orders))) + (.45 * (1-(sum(Units_canceled)/sum(Total_units)))) + (.1 * (1-(sum(Handoff_Missed)/sum(ORDERS))))
end as OFH
from DL_RX_OPERATION.RX_OPS_SANDBOX.OF_DRD
group by all) a
where FISCAL_WEEK_NBR >= (select min(fiscal_week_nbr) from CORE_FSSC.CURATED_CALENDAR.DAY where date_dt = current_date - 84)
group by all);

Create or replace table DL_RX_OPERATION.RX_OPS_SANDBOX.OFP as
(Select 

a.PROGRAM
,a.FS_AREA_NBR as DIVISION
,a.FS_REGION_NBR as REGION
,a.FS_DISTRICT_NBR as DISTRICT
,a.STORE_NBR as STORE_NO

,LW_ORDERS as "LW ORDERS"
,LW_PROCESSED_ON_TIME/LW_ORDERS as "LW On Time %"
,1 - (LW_UNITS_CANCELED/LW_TOTAL_UNITS) as "LW Packed In Full %"
,1 - (LW_HANDOFF_MISSED/LW_ORDERS) as "LW Handoff Success %"

,b.SCORE as "CFR HEALTH SCORE"
,b.HEALTH as "CFR HEALTH"
,a.OFH as "Online Fulfillment Health Score"
,a.OFH_SCORE as "Online Fulfillment Health"
, case when a.Store_nbr = 'ALL' then 'DRD' else "Acute_Chronic_Indicator" end as "Store Acute/Chronic Indicator"

,LM_ORDERS as "LM Orders"
,LM_PROCESSED_ON_TIME/LM_ORDERS as "LM On Time %"
,1 - (LM_UNITS_CANCELED/LM_TOTAL_UNITS) as "LM Packed In Full %"
,1 - (LM_HANDOFF_MISSED/LM_ORDERS) as "LM Handoff Success %"

,YTD_ORDERS as "YTD Orders"
,YTD_PROCESSED_ON_TIME/YTD_ORDERS as "YTD On Time %"
,1 - (YTD_UNITS_CANCELED/YTD_TOTAL_UNITS) as "YTD Packed In Full %"
,1 - (YTD_HANDOFF_MISSED/YTD_ORDERS) as "YTD Handoff Success %"

from DL_RX_OPERATION.RX_OPS_SANDBOX.OF_ROLLUPS_TIMEFRAMES_DRD a
left join CFR_ROLLUPS_TIMEFRAMES_DRD b
on a.fs_area_nbr = b.division
and a.fs_region_nbr = b.region
and a.fs_district_nbr = b.district
and a.store_nbr = b.store_nbr

left join CHRONIC_ACUTE c
on a.fs_area_nbr = c.fs_area_nbr
and a.fs_region_nbr = c.fs_region_nbr
and a.fs_district_nbr = c.fs_district_nbr
and a.store_nbr = c.store_nbr
);

Create or replace table DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_OFH_CAT_CANCEL_unit_update as 
(Select 
Division
,Region
,District
,store_nbr
--,MDSE_grp_DSC
,cat_dsc
,"Full or Partial"
,count(distinct a.ORDER_NO) Orders
from 
(Select ORDER_NO	
,ORDER_LINE_KEY	
,ITEM_ID	
,CAT_DSC	
--,MDSE_GRP_DSC	
,ORIGINAL_ORDERED_QTY	
,cancellation_reason
from Store_Ops_BOPIS_Category_cancelations
where order_no in (Select Order_no from DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_BOPIS_Order_flags 
where actioned_date in ((Select Date_dt from "CORE_FSSC"."CURATED_CALENDAR"."DAY"where FISCAL_MONTH_NBR = (SELECT min(fiscal_month_nbr)
FROM (select distinct fiscal_month_nbr from "CORE_FSSC"."CURATED_CALENDAR"."DAY"where date_dt between current_date - 30 and current_date)a))
))
Union
Select ORDER_NO	
,ORDER_LINE_KEY	
,ITEM_ID	
,CAT_DSC	
--,MDSE_GRP_DSC	
,ORIGINAL_ORDERED_QTY	
,cancellation_reason 
from Store_Ops_SDD_Category_cancelations
where order_no in (Select Order_no from DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_SDD_Order_flags
where actioned_date in ((Select Date_dt from "CORE_FSSC"."CURATED_CALENDAR"."DAY" where FISCAL_MONTH_NBR = (SELECT min(fiscal_month_nbr)
FROM (select distinct fiscal_month_nbr from "CORE_FSSC"."CURATED_CALENDAR"."DAY" where date_dt between current_date - 30 and current_date)a))
))) a
left join
(Select * from Store_Ops_BOPIS_Full_Or_Partial
Union
Select * from DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_SDD_Full_Or_Partial) b
on a.order_no = b.order_no
left join 
(Select * from DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_BOPIS_Order_DRD
Union
Select * from Store_Ops_SDD_Order_DRD) c
on a.order_no = c.order_no
where CAT_DSC is not null
and Division is not null
group by all);

Create or replace table DL_RX_OPERATION.RX_OPS_SANDBOX.Store_Ops_SFS_Resourced as (
Select Shipnode_key as STORE_NO
, FS_AREA_NBR
, FS_REGION_NBR
, FS_DISTRICT_NBR
, count(distinct(resourced_orders)) as resourced_orders
from "OUTPUT_PREP"
Left join CORE_RX.CURATED_LOCATION.STORE
on shipnode_key = Store_nbr
Left join CORE_FSSC.CURATED_CALENDAR.DAY
on DUE_DTTM = DATE_DT
where fiscal_month_nbr between 
(Select to_number(left(min(Fiscal_month_nbr),4) || '01')
from "CORE_FSSC"."CURATED_CALENDAR"."DAY"
where date_dt between current_date - 30 and current_date)
and 
(Select min(Fiscal_month_nbr)
from "CORE_FSSC"."CURATED_CALENDAR"."DAY"
where date_dt between current_date - 35 and current_date)
group by all);

END;
$$;

-----------------
--Validation
-----------------

--Chain level varaince to old excel is unknown but the new total aligns closely with the teradata table. Likely there is a bug that duplicates orders in the old OFP report

--Select PROGRAM
--,sum(orders) 
--from DL_RX_OPERATION.RX_OPS_SANDBOX.BOPIS_SDD_ORDERS
--where store_nbr = 9795
--and fiscal_month_nbr = 202505
--group by all;
--Select 
--sum(orders) 
--from OF_Orders 
--where program in('SDD','BOPIS')
--and fiscal_month_nbr between 202501 and 202505
--and store_nbr in (select store_nbr from CORE_FSSC.CURATED_LOCATION.STORE where FS_AREA_NBR = 5)
--group by all;
