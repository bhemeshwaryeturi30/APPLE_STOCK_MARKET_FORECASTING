SELECT 
CENTRAL_FILL_FACILITY_ID AS CF_STORE_NBR
,STORE_NBR
,STATE_CD AS ST_CD
,TIMEZONE_DSC AS TM_ZONE
,CAL_DAY.FISCAL_MONTH_NBR
,CAL_DAY.FISCAL_WEEK_NBR
,CAL_DAY.DAY_OF_WEEK_DSC AS DOW
,HOUR(TIME_ADJ_HOLDING_QUEUE_OUT_TS) AS HOLDING_QUEUE_OUT_HOUR
,COUNT(PRESCRIPTION_FILL_ID) AS RX_CNT
,MAX(CURRENT_DATE) as UPDATE_DATE
FROM(
    SELECT 
    CF_RX_ASS.CENTRAL_FILL_FACILITY_ID
    ,STR.STORE_NBR
    ,STR.STATE_CD
    ,STR.TIMEZONE_DSC
    ,CF_RX_ASS.HOLDING_QUEUE_OUT_TS
    ,CASE
    WHEN STR.TIMEZONE_DSC = 'Central' THEN TIMESTAMPADD(HOUR,-1,CF_RX_ASS.HOLDING_QUEUE_OUT_TS)
    WHEN STR.TIMEZONE_DSC IN ('Mountain AZ','Mountain') THEN TIMESTAMPADD(HOUR,-2,CF_RX_ASS.HOLDING_QUEUE_OUT_TS)
    WHEN STR.TIMEZONE_DSC = 'Pacific' THEN TIMESTAMPADD(HOUR,-3,CF_RX_ASS.HOLDING_QUEUE_OUT_TS)
    ELSE CF_RX_ASS.HOLDING_QUEUE_OUT_TS
    END AS TIME_ADJ_HOLDING_QUEUE_OUT_TS
    ,CF_RX_ASS.PRESCRIPTION_FILL_ID
    FROM CORE_RX.CURATED_SCRIPT.CENTRAL_FILL_RX_ASSIGNMENT AS CF_RX_ASS
    LEFT JOIN CORE_RX.CURATED_LOCATION.STORE AS STR
        ON STR.STORE_NBR = TO_NUMBER(CF_RX_ASS.HOME_STORE_FACILITY_ID)
    ) AS ASSI
JOIN CORE_FSSC.CURATED_CALENDAR.DAY AS CAL_DAY
    ON CAL_DAY.DATE_DT = TO_DATE(TIME_ADJ_HOLDING_QUEUE_OUT_TS)
    AND CAL_DAY.FISCAL_WEEK_NBR >= 202418
GROUP BY 1,2,3,4,5,6,7,8
