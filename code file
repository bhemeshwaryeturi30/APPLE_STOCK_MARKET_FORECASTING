
--Snowflake Source

--- update the query to anchor on Handoff date vs create date ----

SELECT
FISCAL_YEAR_NBR,
FISCAL_MONTH_NBR,
FISCAL_MONTH_END_DT,
FISCAL_WEEK_NBR,
FISCAL_WEEK_END_DT,
fiscal_week_start_dt,
fiscal_month_start_dt,
BASE.STORE_NBR as CF_STORE_NBR,
--BASE.HOME_STATE,
COUNT(DISTINCT BASE.TRACKING_NBR) as TRACK_CNT,
COUNT(distinct rx_nbr,HOME_STORE,fill_nbr) as RX_CNT
FROM (
    SELECT
    A.TRACKING_NBR,
    A.STORE_NBR,
    CAST(A.DESTINATION_RECIPIENT_TXT AS INT) AS HOME_STORE,
  --  A.DESTINATION_ADDRESS_STATE as HOME_STATE,
    A.OMS_ORDER_NBR,
    B.RX_NBR,
    b.fill_nbr,
    CAST(A.CREATE_TS as DATE) as SHIP_DATE,
    CAL.FISCAL_YEAR_NBR,
    CAL.FISCAL_MONTH_NBR,
    CAL.FISCAL_WEEK_NBR,
    CAL.FISCAL_WEEK_END_DT,
    CAL.FISCAL_MONTH_END_DT,
    cal.fiscal_month_start_dt,
    cal.fiscal_week_start_dt
    FROM CORE_FSSC.CURATED_ORDERS.ORDER_DELIVERY AS A
    INNER JOIN CORE_FSSC.CURATED_ORDERS.ORDER_DELIVERY_ITEM AS B ON A.ORDER_ID = B.ORDER_ID AND A.STORE_NBR = CAST(B.STORE_NBR AS INT)
    INNER JOIN (
        SELECT t1.DATE_DT, t1.FISCAL_WEEK_NBR, t1.FISCAL_MONTH_NBR, t1.FISCAL_YEAR_NBR, 
        t2.END_DT as FISCAL_WEEK_END_DT,
        t3.END_DT as FISCAL_MONTH_END_DT,
        t4.START_DT as FISCAL_YEAR_START_DT, t4.END_DT as FISCAL_YEAR_END_DT,
        t2.start_dt as fiscal_week_start_dt,
        t3.start_dt as fiscal_month_start_dt,
        FROM CORE_FSSC.CURATED_CALENDAR.DAY t1
        INNER JOIN CORE_FSSC.CURATED_CALENDAR.FISCAL_WEEK t2 ON t1.FISCAL_WEEK_NBR = t2.FISCAL_WEEK_NBR
        INNER JOIN CORE_FSSC.CURATED_CALENDAR.FISCAL_MONTH t3 ON t1.FISCAL_MONTH_NBR = t3.FISCAL_MONTH_NBR
        INNER JOIN CORE_FSSC.CURATED_CALENDAR.FISCAL_YEAR t4 ON t1.FISCAL_YEAR_NBR = t4.FISCAL_YEAR_NBR
    ) as CAL ON TO_DATE(A.CREATE_TS) = CAL.DATE_DT
    WHERE 
    A.DELIVERY_SLA_CD in ('CF-STS')
    AND TRACKING_NBR is not null
    --AND CAST(A.CREATE_TS as DATE) BETWEEN '2023-01-01' and '2023-10-07'
    AND MDP_CRM_ORDER_ID is null
    AND A.STORE_NBR in (11507,11506,11339)
    AND FISCAL_YEAR_START_DT >= DATE'2024-01-01'
    AND FISCAL_YEAR_START_DT < CURRENT_DATE
    --AND FISCAL_YEAR_END_DT > CURRENT_DATE
    AND FISCAL_WEEK_END_DT < current_Date
    GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14
) as BASE
GROUP BY 1,2,3,4,5,6,7,8
