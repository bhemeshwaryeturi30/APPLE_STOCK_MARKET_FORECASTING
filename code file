--Snowflake Source

SELECT
cal.FISCAL_YEAR_NBR,
cal.FISCAL_MONTH_NBR,
cal.FISCAL_WEEK_start_DT,
cal.FISCAL_MONTH_END_DT,
cal.FISCAL_WEEK_NBR,
cal.fiscal_month_start_dt,
cal.FISCAL_WEEK_END_DT,
CAST(t1.CENTRAL_FILL_FACILITY_ID as INT) as CF_STORE_NBR,
str.STATE_CD,
CASE WHEN CREATED_TS > SHIP_BY_TS THEN 'Y' ELSE 'N' END as CRTE_AFTER_SLA_FLAG,
COUNT(DISTINCT PRESCRIPTION_FILL_ID) as TOT_RX_CNT,
COUNT(DISTINCT CASE WHEN CENTRAL_FILL_SHIPPING_TS IS NOT NULL THEN PRESCRIPTION_FILL_ID ELSE NULL END) as SHIPPED_CNT,
COUNT(DISTINCT 
    CASE 
    WHEN CENTRAL_FILL_SHIPPING_TS IS NOT NULL AND 
    (TO_DATE(CENTRAL_FILL_SHIPPING_TS) <= TO_DATE(SHIP_BY_TS)
    OR 
    (HOLDING_QUEUE_OUT_TS IS NOT NULL AND 
    (TO_DATE(CENTRAL_FILL_SHIPPING_TS) <= TO_DATE(HOLDING_QUEUE_OUT_TS)
    OR (DAYNAME(HOLDING_QUEUE_OUT_TS) = 'Sun' AND TO_DATE(CENTRAL_FILL_SHIPPING_TS) <= TO_DATE(HOLDING_QUEUE_OUT_TS)+1)
    ))) THEN PRESCRIPTION_FILL_ID 
    ELSE NULL END) as SLA_MET_CNT,
COUNT(DISTINCT 
    CASE 
    WHEN CENTRAL_FILL_SHIPPING_TS IS NOT NULL AND TO_DATE(CENTRAL_FILL_SHIPPING_TS) <= TO_DATE(SHIP_BY_TS) THEN PRESCRIPTION_FILL_ID 
    ELSE NULL END) as SLA_MET_CNT_OLD
--COUNT(DISTINCT CASE WHEN CREATED_TS > SHIP_BY_TS THEN PRESCRIPTION_FILL_ID ELSE NULL END) as CRTE_AFTER_SLA_CNT
FROM CORE_RX.CURATED_SCRIPT.CENTRAL_FILL_RX_ASSIGNMENT t1
INNER JOIN SEM_RX.COMMON_RX.SEM_STORE as STR ON t1.HOME_STORE_FACILITY_ID = STR.STORE_NBR
INNER JOIN (
    SELECT t1.DATE_DT, t1.FISCAL_WEEK_NBR, t1.FISCAL_MONTH_NBR, t1.FISCAL_YEAR_NBR, 
    t2.END_DT as FISCAL_WEEK_END_DT,
    t3.END_DT as FISCAL_MONTH_END_DT,
    t4.START_DT as FISCAL_YEAR_START_DT, t4.END_DT as FISCAL_YEAR_END_DT,
    t2.start_dt as FISCAL_WEEK_start_DT,
    t3.start_dt as fiscal_month_start_dt,
    FROM CORE_FSSC.CURATED_CALENDAR.DAY t1
    INNER JOIN CORE_FSSC.CURATED_CALENDAR.FISCAL_WEEK t2 ON t1.FISCAL_WEEK_NBR = t2.FISCAL_WEEK_NBR
    INNER JOIN CORE_FSSC.CURATED_CALENDAR.FISCAL_MONTH t3 ON t1.FISCAL_MONTH_NBR = t3.FISCAL_MONTH_NBR
    INNER JOIN CORE_FSSC.CURATED_CALENDAR.FISCAL_YEAR t4 ON t1.FISCAL_YEAR_NBR = t4.FISCAL_YEAR_NBR
) as CAL ON TO_DATE(t1.SHIP_BY_TS) = CAL.DATE_DT
WHERE SHIP_BY_TS IS NOT NULL
AND FISCAL_YEAR_START_DT >= DATE'2024-01-01'
AND CAL.FISCAL_YEAR_START_DT < CURRENT_DATE
AND CAL.FISCAL_YEAR_END_DT > CURRENT_DATE
AND CAL.FISCAL_WEEK_END_DT < CURRENT_DATE
AND CREATED_TS < SHIP_BY_TS --expectation to ship by the day it drops in 
GROUP BY 1,2,3,4,5,6,7,8,9,10
