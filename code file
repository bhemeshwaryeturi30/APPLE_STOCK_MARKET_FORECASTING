With CF_DATA AS (
SELECT 
     XREF.STORE_NBR
    ,XREF.FILL_NBR
    ,XREF.RX_NBR
    ,ACT.PROCESSING_STORE_NBR AS CF_STORE_NBR
    ,CF_ASSI.CENTRAL_FILL_FACILITY_ID
    ,ACT.RXC_PRESCRIPTION_FILL_ID
    ,ACT.ACTIVITY_CD
    ,ACT.EFFECTIVE_TS
    ,ACT.REC_EFF_TS
    ,act.CREATE_USER
    ,act.first_nm
    ,act.last_nm 
    ,act.user_credentials
    ,emp_det.JOB_TITLE_NM
    ,ACT.EFFECTIVE_TS::DATE AS EFFECTIVE_DT
    ,LPAD(TO_VARCHAR(DATE_PART('hour', ACT.EFFECTIVE_TS)), 2, '0') || ':' ||
      LPAD(FLOOR(DATE_PART('minute', ACT.EFFECTIVE_TS) / 15) * 15, 2, '0') ||
      '-' ||
      LPAD(
        CASE
          WHEN DATE_PART('minute', ACT.EFFECTIVE_TS) < 15 THEN 15
          WHEN DATE_PART('minute', ACT.EFFECTIVE_TS) < 30 THEN 30
          WHEN DATE_PART('minute', ACT.EFFECTIVE_TS) < 45 THEN 45
          ELSE 0
        END, 2, '0'
      ) AS EFFECTIVE_TS_quarter_label,
    LPAD(TO_VARCHAR(DATE_PART('hour', ACT.EFFECTIVE_TS)), 2, '0') || ':00-' ||
    LPAD(TO_VARCHAR((DATE_PART('hour', ACT.EFFECTIVE_TS) + 1) % 24), 2, '0') || ':00' AS hour_label
FROM CORE_RX.CURATED_SCRIPT.PRESCRIPTION_FILL_ACTIVITY as act
JOIN CORE_RX.CURATED_SCRIPT.CENTRAL_FILL_RX_ASSIGNMENT AS CF_ASSI
    ON CF_ASSI.PRESCRIPTION_FILL_ID = ACT.RXC_PRESCRIPTION_FILL_ID
JOIN CORE_RX.CURATED_SCRIPT.PRESCRIPTION_FILL_XREF AS XREF
    ON XREF.RXC_PRESCRIPTION_FILL_ID = ACT.RXC_PRESCRIPTION_FILL_ID
left join CORE_RX.CURATED_SENSITIVE.EMPLOYEE as emp_det 
    on emp_det.EMPLOYEE_ID = act.employee_id 
WHERE CF_ASSI.REC_EFF_TS::DATE BETWEEN CURRENT_DATE() - 60 AND CURRENT_DATE()
--AND ACT.EFFECTIVE_TS::DATE BETWEEN CURRENT_DATE() - 30 AND TO_DATE(ACT.EFFECTIVE_TS) <= CURRENT_DATE()
and TO_DATE(ACT.EFFECTIVE_TS) >= CURRENT_DATE() - 60 AND TO_DATE(ACT.EFFECTIVE_TS) <= CURRENT_DATE()
AND ACT.ACTIVITY_CD IN (3,74,75)
),
 
TEMP AS (
SELECT
    CENTRAL_FILL_FACILITY_ID,
    FIRST_NM,
    LAST_NM,
    JOB_TITLE_NM,
    EFFECTIVE_DT,
    hour_label,
    COUNT(DISTINCT STORE_NBR,FILL_NBR,RX_NBR) AS SCRIPT_CNT,
    COUNT(DISTINCT EFFECTIVE_TS_quarter_label) AS QUATER_CNT,
    FISCAL_WEEK_NBR
FROM CF_DATA
JOIN CORE_FSSC.CURATED_CALENDAR.DAY AS CAL_DAY
    ON CAL_DAY.DATE_DT = TO_DATE(EFFECTIVE_DT)
  GROUP BY ALL
)
SELECT 
    CENTRAL_FILL_FACILITY_ID,
    FIRST_NM,
    LAST_NM,
    JOB_TITLE_NM,
    EFFECTIVE_DT AS ACTIVITY_DT,
    FISCAL_WEEK_NBR,
    sum(SCRIPT_CNT) as total_Scripts,
    (SCRIPT_CNT/QUATER_CNT) AS AVG_HOURLY_VOL,
    ROUND(SUM(QUATER_CNT)/4,1) AS HOURS_WORKED
FROM TEMP 
GROUP BY ALL
having total_Scripts >2
ORDER BY CENTRAL_FILL_FACILITY_ID,ACTIVITY_DT,AVG_HOURLY_VOL DESC
