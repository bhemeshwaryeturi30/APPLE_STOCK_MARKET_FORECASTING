

✅ 3. Short Email-Style Summary You Can Send to Your Manager

Subject: Summary of Differences Between Two RTS Codebases

Hi ,

I reviewed the two RTS-related SQL codebases and summarized the core differences:

1. Scope
	•	Code 1 is a lightweight analytics script designed for quick insights into RTS rates, copay distribution, acute vs maintenance patterns, and generic vs brand behavior.
	•	Code 2 is a full ETL pipeline with detailed RTS logic, QV2 extraction, refill behavior modeling, fill source classification, fiscal-week rollups, and an enterprise-ready dashboard output.

2. Logic Differences
	•	Code 1 uses simplified date windows and basic RTS joins, while Code 2 has dynamic fiscal-week calculations, multi-source joins (PF, PF_HISTORY, PF_ACTIVITY, DRUG, READYFILL, STORE DIM), and advanced 4-/6-/12-month lookback windows.
	•	Code 2 includes robust logic: identifying first RTS event, deriving QV2_IND, modeling refill history with LAG functions, and classifying fills (RF, eRx, manual, IVR/digital).
	•	Only Code 1 performs copay binning and therapeutic segmentation (acute/generic indicators).

3. Output
	•	Code 1 outputs ad-hoc analytical tables.
	•	Code 2 produces a curated, consistent, dashboard-ready table (RETURN_TO_STOCK_NEW_DASHBOARD) for operational reporting.

4. Complexity
	•	Code 1 is suitable for exploration and trend analysis.
	•	Code 2 is a complete production workflow designed for recurring reporting with comprehensive RTS and verification metrics.


⸻

✅ ETL FLOW DIAGRAM — CODE 1

Prescription Fill + RTS + Copay + Acute/Generic Analytics

                    ┌──────────────────────────────┐
                    │ 1. SELECT DATE RANGE          │
                    │  Fiscal Quarter → START/END   │
                    └──────────────────────────────┘
                                   │
                                   ▼
                    ┌──────────────────────────────┐
                    │ 2. LOAD PRESCRIPTION_FILL     │
                    │  • PF + DRUG details          │
                    │  • DAY_SUPPLY_QTY             │
                    │  • Acute / Generic flags      │
                    └──────────────────────────────┘
                                   │
                                   ▼
           ┌────────────────────────────────────────────────┐
           │ 3. JOIN RETURN-TO-STOCK SOURCES                 │
           │  • RTS_INVENTORY_EVENT_DETAIL                   │
           │  • INVENTORY_EVENT (ACTIVITY_TYPE_ID = 6)       │
           │  → Create RTS flag (RTS_SCRIPT)                 │
           └────────────────────────────────────────────────┘
                                   │
                                   ▼
                    ┌──────────────────────────────┐
                    │ 4. COPAY BINNING             │
                    │  Create ranges: $0, $0–$5,...│
                    └──────────────────────────────┘
                                   │
                                   ▼
                    ┌──────────────────────────────┐
                    │ 5. BUILD PF_DATA TABLE        │
                    │  Combined PF + RTS + Copay    │
                    └──────────────────────────────┘
                                   │
                                   ▼
      ┌────────────────────────────────────────────────────────┐
      │ 6. ANALYTICS LAYERS                                    │
      │  • RTS performance (overall, by bin, by acute/generic) │
      │  • Average copay, medians                              │
      │  • Maintenance vs Acute medications                    │
      │  • Generic vs Brand                                    │
      └────────────────────────────────────────────────────────┘

                                   ▼
                    **FINAL OUTPUT → Analysis Tables Only**


⸻

✅ ETL FLOW DIAGRAM — CODE 2

Full Enterprise Return-to-Stock Pipeline + Dashboard Creation

                   ┌──────────────────────────────────┐
                   │ 1. GET FISCAL WEEK RANGE         │
                   │ Min & Max fiscal week → dates    │
                   └──────────────────────────────────┘
                                   │
                                   ▼
         ┌────────────────────────────────────────────────┐
         │ 2. CREATE BASE RX POPULATION                    │
         │ • PF + PF_HISTORY (WB/SOLD/RTS statuses)        │
         │ • 6-month window                                │
         └────────────────────────────────────────────────┘
                                   │
                                   ▼
         ┌────────────────────────────────────────────────┐
         │ 3. QV2 VERIFICATION LOGIC                       │
         │ • Use PF_XREF + PF_ACTIVITY                     │
         │ • Extract ACTIVITY_CD = 4                       │
         │ • Compute MIN_QV2_DATE, QV2_IND                 │
         └────────────────────────────────────────────────┘
                                   │
                                   ▼
         ┌────────────────────────────────────────────────┐
         │ 4. RETURN-TO-STOCK (RTS) LOGIC                  │
         │ • RTS_INVENTORY_EVENT_DETAIL                    │
         │ • ROW_NUMBER() → first RTS event                │
         │ • MIN_RTS_DATE                                   │
         └────────────────────────────────────────────────┘
                                   │
                                   ▼
        ┌───────────────────────────────────────────────────┐
        │ 5. ENRICH WITH DRUG + STORE + PATIENT INFO        │
        │ • Join DRUG → GCN                                 │
        │ • Join STORE → area, district, region             │
        │ • Bring PF timestamps                             │
        └───────────────────────────────────────────────────┘
                                   │
                                   ▼
        ┌───────────────────────────────────────────────────┐
        │ 6. 12-MONTH FILL HISTORY LOGIC                    │
        │ • Historical PF matching via patient + GCN        │
        │ • LAG() → previous schedule reason, POS time      │
        │ • Derive:                                         │
        │    FILL_HISTORY_IND                               │
        │    FILL_NUMBER (Fill 00 vs 01+)                   │
        └───────────────────────────────────────────────────┘
                                   │
                                   ▼
       ┌─────────────────────────────────────────────────────┐
       │ 7. FILL SOURCE CLASSIFICATION                       │
       │ • READYFILL enrollment checks                       │
       │ • DIM_RX_FILL_SOURCE join                           │
       │ • Categorize: RF, eRx, Manual, IVR/Digital, Other   │
       └─────────────────────────────────────────────────────┘
                                   │
                                   ▼
       ┌─────────────────────────────────────────────────────┐
       │ 8. FISCAL WEEK AGGREGATIONS – QV2 BASED             │
       │ • TTL_VERIFIED                                      │
       │ • RTS within 5/30 days                              │
       │ • TTL_RTS overall                                   │
       │ • Compute RTS_RATE                                  │
       └─────────────────────────────────────────────────────┘
                                   │
                                   ▼
       ┌─────────────────────────────────────────────────────┐
       │ 9. VOLUME-LEVEL AGGREGATIONS (Multi-RTS Events)     │
       │ • Count repeated RTS events                         │
       │ • TTL_RTS_VOLUME / TTL_QV2_VOLUME                   │
       │ • RTS_VOLUME_RATE                                   │
       └─────────────────────────────────────────────────────┘
                                   │
                                   ▼
        ┌────────────────────────────────────────────────────┐
        │ 10. MERGE QV2 + VOLUME METRICS                     │
        │ → RX_LEVEL_FINAL_TABLE                             │
        └────────────────────────────────────────────────────┘
                                   │
                                   ▼
        ┌────────────────────────────────────────────────────┐
        │ 11. CREATE FINAL DASHBOARD TABLE                   │
        │ RETURN_TO_STOCK_NEW_DASHBOARD                     │
        │ • Fiscal week attributes (start dt, end dt)        │
        │ • RTS metrics                                      │
        │ • Verified metrics                                 │
        └────────────────────────────────────────────────────┘

                                   ▼
                       **FINAL OUTPUT → Dashboard Table**


