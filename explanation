SELECT
    a.STORE_ID as STORE_ID
    ,(case when a.BUSINESS_AREA='FS' then FS_DISTRICT_NBR 
           when a.BUSINESS_AREA='RX' then RX_DISTRICT_NBR end) as DISTRICT
    ,(case when a.BUSINESS_AREA='FS' then FS_REGION_NBR 
           when a.BUSINESS_AREA='RX' then RX_REGION_NBR end) as REGION
    ,(case when a.BUSINESS_AREA='FS' then FS_AREA_NBR 
           when a.BUSINESS_AREA='RX' then RX_AREA_NBR end) as DIVISION  
    ,(case when a.BUSINESS_AREA='FS' then 'NA' 
           when a.BUSINESS_AREA='RX' then RX_MAJOR_REGION end) as Major_Region
    ,NULL as Major_Region_No
    ,a.YEAR_MONTH as YEAR_MONTH
    ,a.METRIC_NAME as METRIC_NAME
    ,a.FOLLOW_UP_REQ as FOLLOW_UP_REQ
    ,m.TYPE as STORE_TYPE
    ,m.METRIC_TYPE as METRIC_TYPE
    ,m.FOCUS_AREA as FOCUS_METRIC
    ,m.FOCUS_AREA_CD as FOCUS_METRIC_CD
    ,m.METRIC_NAME_BI as METRIC_CALC
    ,try_cast(m.PRIORITY as INTEGER) as PRIORITY
    ,w.weights as Wt_Multiplier
    ,1 * Wt_Multiplier as Points_Lost
    
    -- ⭐ State Mapping Columns
    ,smm.STATE_PRIORITY AS STATE_PRIORITY
    ,smm.PRIORITY AS STATE_METRIC_PRIORITY   -- ⭐ Added from mapping table

    -- Existing Rank
    ,rank() over (
        partition by a.STORE_ID, a.YEAR_MONTH, m.TYPE
        order by Points_Lost desc, try_cast(m.PRIORITY as INTEGER) asc
    ) as PRIORITY_Rank
    
    -- ⭐ NEW: State Priority Rank
    ,dense_rank() over (
        partition by a.STORE_ID, a.YEAR_MONTH, m.TYPE
        order by smm.PRIORITY asc
    ) AS STATE_PRIORITY_RANK

FROM "APP_SOCS"."SL_SOCS_RPT"."COMPLIANCE_METRICS_FACT_DTL" a

JOIN "APP_SOCS"."SL_SOCS_RPT"."STORE_DIM_RHODY" s     
    ON a.store_id = s.STORE_NBR

JOIN "APP_SOCS"."SL_SOCS_RPT"."FISCAL_MONTH" f  
    ON trim(to_char(a.YEAR_MONTH)) = trim(f.FISCAL_MONTH_NBR)

JOIN "APP_SOCS"."SL_SOCS_RPT"."OPI_METRIC_MASTER_LOOKUP" m
    ON a.metric_name = m.METRIC_NAME_BI
    AND SUBSTR(TO_CHAR(a.YEAR_MONTH), 1, 4) = m.year
    AND ((case when m.TYPE='Pharmacy' then 'RX'
               when m.TYPE='Front Store' then 'FS' END) = a.BUSINESS_AREA)

JOIN "APP_SOCS"."SL_SOCS_RPT"."OPI_METRIC_WEIGHTS" w 
    ON m.metric_id = w.metric_id 
   AND m.type = w.type  
   AND m.year = w.year

-- ⭐ Store-Type-Based Mapping Join
JOIN state_metrics_mapping_pharmacy smm
    ON smm.STATE = s.STATE
   AND smm.METRIC_NAME_BI = m.METRIC_NAME_BI
   AND smm.STORE_TYPE = m.TYPE

WHERE
    a.METRIC_CODE in ('FCS007','FCS006','FCS008','FCS005','FCS004','FCS002','FCS001','FCS003')
    AND a.FOLLOW_UP_REQ = 1
    AND (
            (RX_IND='N' 
                AND s.FS_AREA_NBR IN (1,2,3,4,5,7,8,9,12) 
                AND s.FS_DISTRICT_NBR NOT IN (99,98,97) 
                AND s.FS_DISTRICT_NBR IN (1,2,3,4,5,6))
         OR (RX_IND='Y' 
                AND s.RX_AREA_NBR IN (1,2,3,4,5,7,8,9,12) 
                AND s.RX_DISTRICT_NBR NOT IN (99,98,97)
                AND s.RX_DISTRICT_NBR IN (20,21,22,23,24,25,26,27,28,29))
        )
    AND DIVISION IN (1,2,3,4,5,7,8,9,12)
    AND YEAR_MONTH >= 202401;

