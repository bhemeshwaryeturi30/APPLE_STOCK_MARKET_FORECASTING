DEV Deprioritization Rates Automation

This automated SQL process calculates and refreshes overall prescription deprioritization rates for the CVS pharmacy chain. The workflow runs weekly in the development (DEV) environment through Alation automation, executing every Wednesday at 10:30 AM. The results are then uploaded to Tableau on Thursday at 8 AM, allowing for data latency and Teradata processing time.

The process measures how often prescription verification queues (PVQs) are deprioritized across various attributes (e.g., doctor, signature, drug, prescriber, patient, etc.) and compares these against prescriptions that were not deprioritized. It provides an enterprise-wide deprioritization rate view that supports quality control, compliance, and operational improvement initiatives.

⸻

Overview

The goal of this workflow is to quantify deprioritization patterns within the prescription verification process. By analyzing fill-level prescription data over a six-week rolling window, the process categorizes prescriptions into:
	1.	Deprioritized (Y) – all relevant flags marked as ‘Y’.
	2.	Not Deprioritized (N) – all flags marked as ‘N’.
	3.	Partially Deprioritized – prescriptions where at least one deprioritization flag was ‘Y’.

The aggregated results are summarized by fiscal week and store, and merged into a final dataset (MD_DEPRIOR_RATE) for reporting and visualization in Tableau.

⸻

Workflow Logic

Step 1 – Extract and Stage Deprioritized Prescriptions

Creates a temporary table MD_DEPRIORALL37 pulling records from:
	•	CORE_RX.CURATED_SCRIPT.PRESCRIPTION_VERIFICATION_QUEUE
	•	CORE_RX.CURATED_SCRIPT.PRESCRIPTION_FILL

Filters Applied:
	•	Prescriptions filled in the last 72 days (≈ 6 weeks).
	•	QV_STATUS_CD = 122 and QV_DISPOSITION_CD = 64.
	•	RX_ORIGIN_CD = 3 and FILL_STATUS_CD IN (6,7,9).

Each record checks seven deprioritization flags:
	•	Supervisor/Doctor, Signature, Drug, Prescriber, Prescription Date, Patient, Quantity.

Binary indicators (1 for Y, 0 for N) are created for each flag.

⸻

Step 2 – Aggregate Fill-Level Deprioritizations

The table MD_FINALDEPRIORALL37 consolidates deprioritization events at the fill level, taking the maximum flag value across all queue records.

MD_LASTFORDEPRIORALL37 then joins store attributes from SEM_RX.COMMON_RX.SEM_STORE to classify stores into Retail vs. Non-Retail chains.

This output aggregates the deprioritization sums by store and prepares for chain-wide rollups.

⸻

Step 3 – Generate Overall Deprioritization Totals

The table DL_RX_OPERATION.RX_OPS_SANDBOX.OVERALLDEPRIORRATE is created as a permanent store-level summary, joined with:
	•	CORE_FSSC.CURATED_CALENDAR.DAY for FISCAL_WEEK_NBR.
	•	SEM_STORE for location attributes.

It computes total counts for each deprioritization flag (SIGDPRTZ, DRUGDPRTZ, PNTDPRTZ, etc.) and total fills (XCOUNTERX) across all stores for the last six weeks.

⸻

Step 4 – Identify Non-Deprioritized Prescriptions

Creates tables MD_DEPRIORNOT37, MD_FINALDEPRIORNOT37, and MD_LASTNOT37 for all prescriptions with no deprioritization flags.

Logic:
	•	A fill is considered “Not Deprioritized” if all seven deprioritization indicators = ‘N’.
	•	Aggregates all qualifying fills by fiscal week using the calendar join.

The results are stored in the permanent table:
DL_RX_OPERATION.RX_OPS_SANDBOX.MD_FINALRESULTSN37, containing:
	•	FISCAL – Fiscal Week
	•	ALL_NOT_DEPRIORITIZED – Count of non-deprioritized prescriptions
	•	NCOUNTERN – Total fills processed

⸻

Step 5 – Identify Fully Deprioritized Prescriptions

Similar logic is applied for prescriptions where all seven deprioritization flags = ‘Y’, captured through MD_DEPRIORYES37, MD_FINALDEPRIORYES37, and MD_LASTONE37.

The final summary table DL_RX_OPERATION.RX_OPS_SANDBOX.MD_FINALRESULTSY37 is created to record:
	•	FW – Fiscal Week
	•	ALL_DEPRIORITIZED – Count of fully deprioritized prescriptions
	•	YCOUNTERY – Total fills processed

⸻

Step 6 – Merge and Produce Final Deprioritization Rates

The final output table DL_RX_OPERATION.RX_OPS_SANDBOX.MD_DEPRIOR_RATE merges all key datasets:
	•	OVERALLDEPRIORRATE (chain-level totals)
	•	MD_FINALRESULTSN37 (non-deprioritized fills)
	•	MD_FINALRESULTSY37 (fully deprioritized fills)

Join Logic:

RIGHT JOIN MD_FINALRESULTSN37 ON OA.FISCAL_WEEK_NBR = ND.FISCAL
RIGHT JOIN MD_FINALRESULTSY37 ON ND.FISCAL = YD.FW

The resulting dataset provides a week-by-week summary of deprioritization performance metrics across the chain.


